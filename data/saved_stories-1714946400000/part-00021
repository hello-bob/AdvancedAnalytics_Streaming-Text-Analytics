{"aid": "40263841", "title": "Eco-CI: CO2 Emissions of GitHub/Gitlab Pipelines", "url": "https://github.com/marketplace/actions/eco-ci-energy-estimation", "domain": "github.com/marketplace", "votes": 1, "user": "ArneTR", "posted_at": "2024-05-05 10:52:09", "comments": 0, "source_title": "Eco CI Energy Estimation - GitHub Marketplace", "source_text": "Eco CI Energy Estimation \u00b7 Actions \u00b7 GitHub Marketplace \u00b7 GitHub\n\nSkip to content\n\n## Navigation Menu\n\nSign in\n\n# Search code, repositories, users, issues, pull requests...\n\nSearch syntax tips\n\nSign in\n\nSign up\n\nYou signed in with another tab or window. Reload to refresh your session. You\nsigned out in another tab or window. Reload to refresh your session. You\nswitched accounts on another tab or window. Reload to refresh your session.\nDismiss alert\n\n### GitHub Action\n\n# Eco CI Energy Estimation\n\nv3.1 Latest version\n\n# Eco-CI\n\nEco-CI is a project aimed at estimating energy consumption in continuous\nintegration (CI) environments. It provides functionality to calculate the\nenergy consumption of CI jobs based on the power consumption characteristics\nof the underlying hardware.\n\n## Usage\n\nEco-CI supports both GitHub and GitLab as CI platforms. When you integrate it\ninto your pipeline, you must call the start-measurement script to begin\ncollecting power consumption data, then call the get-measurement script each\ntime you wish to make a spot measurement. When you call get-measurment, you\ncan also assign a label to it to more easily identify the measurement. At the\nend, call the display-results to see all the measurement results, overall\ntotal usage, and export the data.\n\nFollow the instructions below to integrate Eco-CI into your CI pipeline:\n\n### Github:\n\nTo use Eco-CI in your GitHub workflow, call it with the relevant task name\n(start-measurement, get-measurement, or display-results). Here is a sample\nworkflow that runs some python tests with eco-ci integrated.\n\n    \n    \n    name: Daily Tests with Energy Measurement run-name: Scheduled - DEV Branch on: schedule: - cron: '0 0 * * *' permissions: read-all jobs: run-tests: runs-on: ubuntu-latest steps: - name: Initialize Energy Estimation uses: green-coding-solutions/eco-ci-energy-estimation@v3 # use hash or @vX here (See note below) with: task: start-measurement - name: 'Checkout repository' uses: actions/checkout@v3 with: ref: 'dev' submodules: 'true' - name: Checkout Repo Measurement uses: green-coding-solutions/eco-ci-energy-estimation@v3 # use hash or @vX here (See note below) with: task: get-measurement label: 'repo checkout' - name: setup python uses: actions/setup-python@v4 with: python-version: '3.10' cache: 'pip' - name: pip install shell: bash run: | pip install -r requirements.txt - name: Setup Python Measurment uses: green-coding-solutions/eco-ci-energy-estimation@v3 # use hash or @vX here (See note below) with: task: get-measurement label: 'python setup' - name: Run Tests shell: bash run: | pytest - name: Tests measurement uses: green-coding-solutions/eco-ci-energy-estimation@v3 # use hash or @vX here (See note below) with: task: get-measurement label: 'pytest' - name: Show Energy Results uses: green-coding-solutions/eco-ci-energy-estimation@v3 # use hash or @vX here (See note below) with: task: display-results\n\n#### Github Action Mandatory and Optional Variables:\n\n  * task: (required) (options are start-measurement, get-measurement, display-results)\n\n    * start-measurement - Initialize the action starts the measurement. This must be called, and only once per job.\n    * get-measurement - Measures the energy at this point in time since either the start-measurement or last get-measurement action call.\n    * display-results - Outputs the energy results to the$GITHUB_STEP_SUMMARY. Creates a table that shows the energy results of all the get-measurements, and then a final row for the entire run. Displays the avergae cpu utilization, the total Joules used, and average wattage for each measurment+total run. It will also display a graph of the energy used, and a badge for you to display.\n\n      * This badge will always be updated to display the total energy of the most recent run of the workflow that generated this badge.\n      * The total measurement of this task is provided as output data-total-json in json format (see example below).\n      * Can be used with pr-comment flag (see below) to post the results as a comment on the PR.\n  * branch: (optional) (default: ${{ github.ref_name }})\n\n    * Used with get_measurement and display_results to correctly identify this CI run for the Badge.\n  * label: (optional) (default: 'measurement ##')\n\n    * Used with get_measurement and display_results to identify the measurement\n  * send-data: (optional) (default: true)\n\n    * Send metrics data to metrics.green-coding.io to create and display badge, and see an overview of the energy of your CI runs. Set to false to send no data. The data we send are: the energy value and duration of measurement; cpu model; repository name/branch/workflow_id/run_id; commit_hash; source (GitHub or GitLab). We use this data to display in our green-metrics-tool front-end here: https://metrics.green-coding.io/ci-index.html\n  * show-carbon: (optional) (default: true)\n\n    * Gets the location using http://ip-api.com\n    * Get the CO2 grid intensity for the location from https://www.electricitymaps.com/\n    * Estimates the amount of carbon the measurement has produced\n  * display-table: (optional) (default: true)\n\n    * call during the display-graph step to either show/hide the energy reading table results in the output\n  * display-graph: (optional) (default: true)\n\n    * We use an ascii charting library written in go (https://github.com/guptarohit/asciigraph). For GitHub hosted runners their images come with go so we do not install it. If you are using a private runner instance however, your machine may not have go installed, and this will not work. As we want to minimize what we install on private runner machines to not intefere with your setup, we will not install go. Therefore, you will need to call start-measurement with the display-graph flag set to false, and that will skip the installation of this go library.\n  * display-badge: (optional) (default: true)\n\n    * used with display-results\n    * Shows the badge for the ci run during display-results step\n    * automatically false if send-data is also false\n  * pr-comment: (optional) (default: false)\n\n    * used with display-results\n    * if on, will post a comment on the PR issue with the Eco-CI results. only occurs if the triggering event is a pull_request\n    * remember to set pull-requests: write to true in your workflow file\n  * api-base: (optional) (default: 'api.github.com')\n\n    * Eco-CI uses the github api to post/edit PR comments\n    * set to github's default api, but can be changed if you are using github enterprise\n  * company-uuid: (optional)\n\n    * If you want to add your CI/CD runs to the CarbonDB you can set your company uuid here. If you set this all your runs will be found for your company. Please note that if your CI is public your company uuid will be exposed and other people could check your CO2 footprint.\n    * Please note that we will add the label as a tag so you can see which steps generated how much CO2\n  * project-uuid: (optional)\n\n    * If you want to group your CI/CD runs by project\n  * machine-uuid: (optional)\n\n    * If you want to make the runs look like they all ran on the same machine. This is not recommended as it will not be accurate but can be helpful for debugging.\n\n#### Electricity Maps Token\n\nWe use https://app.electricitymaps.com/ to get the grid intensity for a given\nlocation. This service currently works without specifying a token but we\nrecommend to still get one under https://api-portal.electricitymaps.com/\n\nYou will need to set this token as a secret ELECTRICITY_MAPS_TOKEN. See the\ndocumentation how to do this https://docs.github.com/en/actions/security-\nguides/using-secrets-in-github-actions\n\nYou will also need to set it in your workflow files where you call display-\nresults and get-measurement:\n\n    \n    \n    - name: Eco CI Energy Estimation uses: ./ env: ELECTRICITY_MAPS_TOKEN: ${{ secrets.ELECTRICITY_MAPS_TOKEN }} with: task: display-results pr-comment: true\n\n#### Continuing on Errors\n\nWe recommend running our action with continue-on-error:true, as it is not\ncritical to the success of your workflow, but rather a nice feature to have.\n\n    \n    \n    - name: Eco CI Energy Estimation uses: green-coding-solutions/eco-ci-energy-estimation@v3 with: task: final-measurement continue-on-error: true\n\n#### Consuming the Measurements as JSON\n\nFor both tasks get-measurement and display-results the lap measurements and\ntotal measurement can be consumed in JSON format. You can use the outputs\ndata-lap-json or data-total-json respectively. Here is an example\ndemonstrating how this can be achieved:\n\n    \n    \n    # ... - name: 'Checkout repository' uses: actions/checkout@v3 with: ref: 'dev' submodules: 'true' - name: Checkout Repo Measurment uses: green-coding-solutions/eco-ci-energy-estimation@v3 id: checkout-step with: task: get-measurement label: 'repo checkout' - name: Print checkout data run: | echo \"total json: ${{ steps.checkout-step.outputs.data-lap-json }}\" - name: Show Energy Results uses: green-coding-solutions/eco-ci-energy-estimation@v3 id: total-measurement-step with: task: display-results - name: Print total data run: | echo \"total json: ${{ steps.total-measurement-step.outputs.data-total-json }}\"\n\nNote that the steps you want to consume the measurements of need to have an id\nso that you can access the corresponding data from their outputs.\n\n#### Note on private repos\n\nIf you are running in a private repo, you must give your job actions read\npermissions for the GITHUB_TOKEN. This is because we make an api call to get\nyour workflow_id which uses your $GITHUB_TOKEN, and it needs the correct\npermissions to do so:\n\n    \n    \n    jobs: test: runs-on: ubuntu-latest permissions: actions: read steps: - name: Eco CI - Initialize uses: green-coding-solutions/eco-ci-energy-estimation@v3 with: task: start-measurement\n\n### GitLab:\n\nTo use Eco-CI in your GitLab pipeline, you must first include a reference to\nthe eco-ci-gitlab.yml file as such:\n\n    \n    \n    include: remote: 'https://raw.githubusercontent.com/green-coding-solutions/eco-ci-energy-estimation/main/eco-ci-gitlab.yml'\n\nand you call the various scripts in your pipeline with call like this:\n\n    \n    \n    - !reference [.<function-name>, script]\n\nwhere function name is one of the following: initialize_energy_estimator -\nused to setup the machine for measurement. Needs to be called once per VM job.\nstart_measurement - begin the measurment get_measurement - make a spot\nmeasurment here. If you wish to label the measurement, you need to set the\nECO_CI_LABEL environment variable right before this call. display_results -\nwill print all the measurement values to the jobs-output and prepare the\nartifacts, which must be exported in the normal GitLab way.\n\nBy default, we send data to our API, which will allow us to present you with a\nbadge, and a front-end display to review your results. The data we send are:\nthe energy value and duration of measurement; cpu model; repository\nname/branch/workflow_id/run_id; commit_hash; source (GitHub or GitLab). We use\nthis data to display in our green-metrics-tool front-end here:\nhttps://metrics.green-coding.io/ci-index.html\n\nIf you do not wish to send us data, you can set this global variable in your\npipeline:\n\n    \n    \n    variables: ECO_CI_SEND_DATA: \"false\"\n\nThen, for each job you need to export the artifacts. We currently export the\npipeline data as a regular artifact, as well as make use of GitLab's Metric\nReport artifact (which we output to the default metrics.txt):\n\n    \n    \n    artifacts: paths: - eco-ci-output.txt - eco-ci-total-data.json reports: metrics: metrics.txt\n\nHere is a sample .gitlab-ci.yml example file to illustrate:\n\n    \n    \n    image: ubuntu:22.04 include: remote: 'https://raw.githubusercontent.com/green-coding-solutions/eco-ci-energy-estimation/main/eco-ci-gitlab.yml' stages: - test test-job: stage: test script: - !reference [.initialize_energy_estimator, script] - !reference [.start_measurement, script] - sleep 10s # Your main pipeline logic here - export ECO_CI_LABEL=\"measurement 1\" - !reference [.get_measurement, script] - sleep 3s # more of your pipeline logic here - export ECO_CI_LABEL=\"measurement 2\" - !reference [.get_measurement, script] - !reference [.display_results, script] artifacts: paths: - eco-ci-output.txt reports: metrics: metrics.txt\n\n### How does it work?\n\n  * The Eco-CI at its core makes its energy estimations based on an XGBoost Machine Learning model we have created based on the SpecPower database. The model and further information can be found here: https://github.com/green-coding-solutions/spec-power-model\n  * When you initialize the Eco-CI, it downloads the XGBoost model onto the machine, as well as a small program to track the cpu utilization over a period of time. This tracking begins when you call the start_measurement function. Then, each time you call get-measurement, it will take the cpu-utilization data collected (either from the start, or since the last get-measurement call) and make an energy estimation based on the detected hardware (mainly cpu data) and utilization.\n\n### Limitations\n\n  * At the moment this will only work with linux based pipelines, mainly tested on ubuntu images.\n\n  * If you have your pipelines split over multiple VM's (often the case with many jobs) ,you have to treat each VM as a seperate machine for the purposes of measuring and setting up Eco-CI.\n\n  * The XGBoost model requires the CPU to have a fixed frequency setting. This is typical for cloud testing, but not always the case.\n\n  * The XGBoost model data is trained via the SpecPower database, which was mostly collected on compute machines. Results will be off for non big cloud servers and also for machines that are memory heavy or machines which rely more heavily on their GPU's for computations.\n\n### Note on the integration\n\n  * If you use dependabot and want to get updates, we recommend using the hash notation\n\n    * uses: green-coding-solutions/eco-ci-energy-estimation@06837b0b3b393a04d055979e1305852bda82f044 #v2.2\n    * Note that this hash is just an example. You find the latest current hash under Tags\n  * If you want the extension to automatically update within a version number, use the convenient @v2 form\n\n    * uses: green-coding-solutions/eco-ci-energy-estimation@v3 # will pick the latest minor v2. for example v2.2\n\n##### Stars\n\nStar 21\n\n##### Contributors\n\n##### Categories\n\nContinuous integration Utilities\n\n##### Links\n\ngreen-coding-solutions/eco-ci-energy-estimation Open issues 6 Pull requests 1\nReport abuse\n\nEco CI Energy Estimation is not certified by GitHub. It is provided by a\nthird-party and is governed by separate terms of service, privacy policy, and\nsupport documentation.\n\n## Site-wide Links\n\n### Subscribe to our developer newsletter\n\nGet tips, technical guides, and best practices. Twice a month. Right in your\ninbox.\n\nSubscribe\n\nYou can\u2019t perform that action at this time.\n\n", "frontpage": false}
