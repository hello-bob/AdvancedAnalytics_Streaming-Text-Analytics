{"aid": "40138259", "title": "Fix for Windows Photo Viewer opening files with unknown ICC profiles", "url": "https://github.com/PaaaulZ/PhotoViewerOutOfMemoryNoMore", "domain": "github.com/paaaulz", "votes": 1, "user": "Lammy", "posted_at": "2024-04-23 22:49:53", "comments": 0, "source_title": "GitHub - PaaaulZ/PhotoViewerOutOfMemoryNoMore: Windows Photo Viewer gives \"Out of memory\" error when opening images with unknown color profiles (like Xiaomi/Huawei screenshots). This will fix it", "source_text": "GitHub - PaaaulZ/PhotoViewerOutOfMemoryNoMore: Windows Photo Viewer gives \"Out\nof memory\" error when opening images with unknown color profiles (like\nXiaomi/Huawei screenshots). This will fix it\n\nSkip to content\n\n## Navigation Menu\n\nSign in\n\n# Search code, repositories, users, issues, pull requests...\n\nSearch syntax tips\n\nSign in\n\nSign up\n\nYou signed in with another tab or window. Reload to refresh your session. You\nsigned out in another tab or window. Reload to refresh your session. You\nswitched accounts on another tab or window. Reload to refresh your session.\nDismiss alert\n\nPaaaulZ / PhotoViewerOutOfMemoryNoMore Public\n\n  * Notifications\n  * Fork 0\n  * Star 20\n\nWindows Photo Viewer gives \"Out of memory\" error when opening images with\nunknown color profiles (like Xiaomi/Huawei screenshots). This will fix it\n\n### License\n\nGPL-3.0 license\n\n20 stars 0 forks Branches Tags Activity\n\nStar\n\nNotifications\n\n# PaaaulZ/PhotoViewerOutOfMemoryNoMore\n\nThis commit does not belong to any branch on this repository, and may belong\nto a fork outside of the repository.\n\n2 Branches\n\n6 Tags\n\n## Folders and files\n\nName| Name| Last commit message| Last commit date  \n---|---|---|---  \n  \n## Latest commit\n\nPaaaulZForgot the usage section and I don't want to squash commitsNov 1,\n2023a77ce29 \u00b7 Nov 1, 2023Nov 1, 2023\n\n## History\n\n22 Commits  \n  \n### PhotoViewerPatcher\n\n|\n\n### PhotoViewerPatcher\n\n| Automatic dll permissions| Nov 1, 2023  \n  \n### .gitignore\n\n|\n\n### .gitignore\n\n| Found a way to patch the program itself| Dec 21, 2021  \n  \n### LICENSE\n\n|\n\n### LICENSE\n\n| Create LICENSE| Feb 5, 2022  \n  \n### PhotoViewerPatcher.sln\n\n|\n\n### PhotoViewerPatcher.sln\n\n| Removed old method and ported SigScanner to .net to merge| Jul 20, 2023  \n  \n### README.md\n\n|\n\n### README.md\n\n| Forgot the usage section and I don't want to squash commits| Nov 1, 2023  \n  \n## Repository files navigation\n\n# Windows Photo Viewer Patcher\n\n## Patch \"Out of memory\" exception when opening images containing an unknown\ncolor profile\n\nTested on:\n\n    \n    \n    Windows 7 Enterprise Version 6.1.7601 Service Pack 1 Build 7601 Windows 10 Pro Version 1903 Build 18362.356 Windows 10 Version 22H2 Build 19045.2486 Windows 11 Pro 10.0.22000 build 22000\n\n### Why?\n\nWhy not? Windows Photo Viewer is EOL but i like it and a lot of people still\nuse it. Besides, on a fresh install of Windows 7 you have nothing else to open\nimages (except Paint).\n\n### Usage\n\n  1. Download the lastest release\n  2. Run as Administrator\n  3. Browse for ImagingEngine.dll\n  4. Press \"Patch\"\n\nIf you get an access denied error manually take ownership of the folder and\ngive yourself full read and write permissions\n\n### Before you start\n\nThe DLL we need to patch (ImagingEngine.dll) is usually located in \"C:\\Program\nFiles\\Windows Photo Viewer\\\" or \"C:\\Program Files (x86)\\Windows Photo\nViewer\\\". I suggest patching both the x86 and x64 dll, most of the times\nWindows uses the x86 one even if you are in a x64 environment\n\nNote that sometimes the antivirus may flag the .exe but it's a false positive\nand you can safely add it to the exclusions list.\n\n### How does it work?\n\nWhen the image contains an unknown icc profile Windows Photo Viewer tries to\nperform color mapping by calling CreateMultiProfileTransform but fails, we can\npatch the check to ignore the invalid icc profile and move on. What happens if\nwe ignore the invalid profile? Does it use the default one? I really don't\nknow, I only know it starts working.\n\nThe function flow looks like this:\n\n    \n    \n    7C1D9FD5 | 50 | push eax | 7C1D9FD6 | FF15 50522D7C | call dword ptr ds:[<&CreateMultiProfileTransform>] | 7C1D9FDC | 85C0 | test eax,eax | 7C1D9FDE | 75 0B | jne imagingengine.7C1D9FEB | Jump if ok 7C1D9FE0 | 68 0D031586 | push 8615030D | 7C1D9FE5 | FF15 B4512D7C | call dword ptr ds:[<&?Throw@Base@@YGXJ@Z>] | Prepare exception\n\nChanging the check from JNE to JMP opens the image correctly. Ignoring\nexceptions maybe but do we care? I think not.\n\n### Wanna make your own patch?\n\n  1. Open PhotoViewer. rundll32.exe [path to PhotoViewer.dll],ImageView_Fullscreen [path to image]\n\n     * [path to PhotoViewer.dll] is usually \"C:\\Program Files\\Windows Photo Viewer\\PhotoViewer.dll\" or \"C:\\Program Files (x86)\\Windows Photo Viewer\\PhotoViewer.dll\"\n     * [path to image] must not be quoted!\n  2. Attach your favourite debugger to rundll32.exe\n\n  3. Select the loaded module ImagingEngine.dll\n\n  4. Search for an intermodular call to CreateMultiProfileTransform\n\n  5. Change the JNE to JMP\n\n### Alternative method (patch the single image instead of the software)\n\nYou can edit the image with an hex editor like HxD and corrupt the color\nprofile indication. Search for the string ICC_PROFILE and just change a random\nletter (for example make it ICC_aROFILE). You can now normally open the image\non every computer without needing the patch\n\n## About\n\nWindows Photo Viewer gives \"Out of memory\" error when opening images with\nunknown color profiles (like Xiaomi/Huawei screenshots). This will fix it\n\n### Topics\n\nwindows pictures screenshot xiaomi huawei photoviewer outofmemory\n\n### Resources\n\nReadme\n\n### License\n\nGPL-3.0 license\n\nActivity\n\n### Stars\n\n20 stars\n\n### Watchers\n\n3 watching\n\n### Forks\n\n0 forks\n\nReport repository\n\n## Releases 3\n\nPatcher v1.5 Latest\n\nNov 1, 2023\n\n\\+ 2 releases\n\n## Languages\n\n  * Visual Basic .NET 100.0%\n\n## Footer\n\n\u00a9 2024 GitHub, Inc.\n\nYou can\u2019t perform that action at this time.\n\n", "frontpage": false}
