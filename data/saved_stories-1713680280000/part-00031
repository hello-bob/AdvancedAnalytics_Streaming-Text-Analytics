{"aid": "40100270", "title": "From Terraform to OpenTofu: Why and How", "url": "https://masterpoint.io/updates/opentofu-early-adopters/", "domain": "masterpoint.io", "votes": 1, "user": "mooreds", "posted_at": "2024-04-20 19:30:59", "comments": 0, "source_title": "From Terraform to OpenTofu: Why and How | Masterpoint Consulting", "source_text": "From Terraform to OpenTofu: Why and How | Masterpoint Consulting\n\nMasterpoint stands with Ukraine. Here\u2019s how you can help Ukraine with just a\nfew clicks. >\n\n  * LinkedIn\n\nGET IN TOUCH \u2192\n\n4.08.2024\n\n# From Terraform to OpenTofu: Why and How\n\nBy Matt Gowie\n\nWe're early adopters of OpenTofu. Read about what it took for us to make the\nswitch and how it's going.\n\n### Intro\n\nOn January 29th, we started down the exciting journey of upgrading one of our\nclient projects to OpenTofu. As early adopters of this innovative shift in the\ninfrastructure as code (IaC) landscape, we wanted to share our experience and\nthe steps we took during this migration.\n\nIf you\u2019re not familiar with OpenTofu, the project started shortly after\nHashiCorp changed the licensing of their open-source tools (including\nTerraform) to a Business Source License (BSL) in August of 2023. This event\ncaused significant strife within the Terraform community. This move, which we\nat Masterpoint view as a departure from true open-source principles, prompted\nus to search for alternatives that align with our community-focused values.\nOpenTofu is the recent community-led fork of Terraform and it has emerged as\nthe best alternative. It offers a fully open-source solution designed to be\ncompatible with Terraform\u2019s existing infrastructure as code management\nsoftware, but without the restrictive licensing.\n\n### Why the Migration?\n\nThe question of why we did the migration has come up in conversation\nrepeatedly. It comes down to three reasons:\n\n  1. At Masterpoint, we emphasize and prioritize open-source in our engagements because open-source tooling and communities drive more value faster, ensure the solutions we deliver are secure, and provide clients with long-term support. As a result, we are dedicated open-source developers, contributors, and maintainers in the Terraform and Platform Engineering ecosystem. Truly open-source tooling like OpenTofu aligns with our values.\n\n  2. Regardless of how much we love open-source, we do recognize that certain projects and scenarios call for paid SaaS tools. Spacelift (an IaC Continuous Delivery tool) is one such tool that we\u2019ve used in a number of our client projects. It allows us to deliver great results for our clients without reinventing the wheel with our own pipelines. Since Spacelift can no longer use Terraform v1.6 and above (which are the versions affected by the HashiCorp BSL change), if we wanted to upgrade Terraform then we needed to migrate our pipelines off of Spacelift to Terraform Cloud or another solution. That wasn\u2019t acceptable to us. Instead we chose to migrate off of Terraform and on to OpenTofu, which Spacelift supports, allowing us to stick with tooling we are happy with.\n\n  3. Moving to OpenTofu gave us the ability to keep on top of evolving tools while still remaining true to our beliefs. For instance, we want to be better about testing our IaC logic. TerraTest has been the Terraform standard, but requires writing Golang, which is an obstacle for many of our clients. We were excited to test out terraform test but this new functionality is only available in BSL licensed versions of Terraform. Luckily, by choosing OpenTofu, we gain access to the test command and other future functionality.\n\n### A Little About Our Setup\n\nTo give you a bit of a background, here are high level details about the tools\nand scope of our project:\n\n  * Terraform 1.5.7: The last open-source version before the BS, err, I mean BSL licensing shift.\n\n  * aqua: A tool management system that allows us to specify our tool versions (e.g. TomWright/dasel@v2.6.0, mozilla/sops@v3.7.3, or opentofu/opentofu@v1.6.1).\n\n  * Atmos: Comparable to Terragrunt or Terramate, Atmos is a framework for managing Terraform at scale. This tool plays a crucial role in our infrastructure automation.\n\n  * Spacelift: Our IaC continuous delivery tool, which we leverage to automate all of our infrastructure management.\n\n  * The terraform-spacelift-cloud-infrastructure-automation module: We utilize this module to automate Spacelift, so we don\u2019t need to ClickOps any changes in the Spacelift UI except for \u201cApply\u201d confirmations. We write Atmos YAML stack files, which gives us a completely automated Spacelift platform.\n\nTo give you an idea of the size of the project moved:\n\n  * Our IaC manages 2386 resources across AWS, GitHub, Tailscale, Google Cloud, and many other providers.\n  * We manage over 90 workspaces / state files.\n  * This project has over 39K lines of Terraform code across over 480 files.\n\nTo give you a visual understanding, here is our internal TF Automation diagram\nfor Spacelift:\n\n### What Did We Need To Do?\n\nThe transition to OpenTofu was impressively smooth, with our normal Terraform\ncode requiring not a single change to support compatibility with the new CLI\ntool, tofu, and the OpenTofu framework. We were blown away by that! The\nversion we migrated to, OpenTofu 1.6.1, was only the 2nd release of the\nproject, so we expected to run into at least one issue. We were pleasantly\nsurprised. The compatibility between tofu and terraform out of the gate\nunderscores the OpenTofu team\u2019s serious chops and ability to deliver a\nreliable tool.\n\nNow just because OpenTofu was able to run all of our Terraform code, that\ndoesn\u2019t mean we didn\u2019t need to make any changes at all. Using OpenTofu isn\u2019t\nlike waving a magic wand. To support it in our environment, we needed to\nupdate our Atmos and Spacelift configurations to execute tofu instead of\nterraform. And since OpenTofu was so new, we upstreamed fixes for some\nniggling issues.\n\nHere are the details of those changes:\n\n  1. We had to add OpenTofu to our project so our team members had access to the binary. Since we\u2019re using aqua, this was as simple as running the command aqua generate -i opentofu/opentofu and committing the update!\n  2. We had to update the terraform-spacelift-cloud-infrastructure-automation module to support setting the \u201cworkflow tool\u201d argument to a new OPEN_TOFU value. After we upgraded our internal usage of that module, this change enabled us to designate OpenTofu as our preferred tool, instead of Terraform. The open source PR for that module change was made here.\n  3. We had to update our atmos configuration to ensure that atmos commands executed tofu and not terraform.\n  4. Critically, we had to pass the OPEN_TOFU workflow tool value to Spacelift. This required the following changes in our base atmos _defaults.yaml file:\n\n    \n    \n    terraform: command: tofu settings: spacelift: # Tofu > Terraform terraform_workflow_tool: OPEN_TOFU\n\nAnd that was it! Once that PR got merged, all of our Spacelift Automation and\nlocal usage of Atmos changed over to OpenTofu and we were done! \ud83c\udfc1\n\n### How Long Did It Take?\n\nSure, the changes were minimal, but how long did it really take to implement\nthem?\n\nAs mentioned above, we manage thousands of resources, over 90 workspaces,\n39,000+ lines of code over nearly 500 files. But due to the automation\nMasterpoint has built and compatibility of OpenTofu, this migration took just\nover 7 hours of work across multiple days. I personally did this migration\nwork myself, and I was pleasantly surprised and happy with how quickly it all\ncame together.\n\n### How Has It Been Going?\n\nOur migration journey has been very positive. We\u2019ve only hit a couple minor\nissues that were quickly addressed:\n\n  1. GPG Key signing support for non-mainstream providers is still a WIP. This results in tiny warnings like the screenshot; we find these to be an eyesore and prefer our logs to be clean to avoid missing any true issues. Luckily, for such providers, we\u2019ve opened issues and it appears these will be fixed very soon:\n\n    1. https://github.com/carlpett/terraform-provider-sops/issues/115 \u2013 Fixed!\n    2. https://github.com/cloudposse/terraform-provider-utils/issues/344 (@kevcube is a Masterpoint engineer) \u2013 Fixed!\n    3. https://github.com/tailscale/terraform-provider-tailscale/issues/335 \u2013 Open (as of the time of writing)\n  2. About 3 weeks into our usage of OpenTofu, we ran into an issue related using a recently published version of one of our own modules, masterpointio/terraform-aws-tailscale. The problem was discussed(you can view it in the OpenTofu Slack here) but the core of the issue is that a hiccup in the OpenTofu registry caused our newly published module to not show up until the registry was manually poked. The OpenTofu team was very responsive and helpful in getting this solved and it was fixed within a few hours. We were very appreciative of this short time to resolution. To me, it seems like that team is continuing to work through the outlier bugs in the registry which is understandable considering how new it is. Given the quick fix too, I find this to be a very acceptable problem!\n\n### Conclusion\n\nReflecting on this quick journey from Terraform to OpenTofu, I\u2019m excited about\nthis project! As CEO of Masterpoint, I only spend approximately 10% of my time\nhands on keyboard coding in a typical month, but I was able to personally\naccomplish this migration in a single week of disjointed work. And with those\nchanges we\u2019re now back to supporting a true open-source project and staying\nwithin the toolset that we were already happy with.\n\nSo what\u2019s next? My team and I are definitely excited to continue helping\nclients migrate to OpenTofu \u2013 It feels like the stability and innovation of\nthis project are solid at this point. We feel strongly that more and more\nadoption will happen. We\u2019re also interested in some of the new functionality\ncoming in OpenTofu like state encryption and provider functions. We\u2019re stoked\nto check those out soon. We\u2019d like to share a blog post on one or both of them\nin the coming months.\n\nInterested in migrating from Terraform to OpenTofu or curious about how the\ntools we use can enhance your infrastructure practices? Reach out to us.\nMasterpont is at the forefront of this innovative transition, ready to share\nour expertise or roll up our sleeves to facilitate your success.\n\n### Ready to speed up your application engineering?\n\nUnlock the next evolution of your cloud-architecture. Get in touch and we\u2019ll\nbuild you a custom-tailored proposal for your platform needs.\n\nSchedule Your Free Assessment \u2192\n\n  * Home\n  * Our Services\n  * Who We Are\n  * Updates\n\nCopyright 2024- Masterpoint Consulting - All Rights Reserved. Privacy Policy | Terms and Conditions\n\n", "frontpage": false}
