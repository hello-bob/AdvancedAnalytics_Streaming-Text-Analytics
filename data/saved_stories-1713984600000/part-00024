{"aid": "40142071", "title": "Microsoft Warbird and Protected Media Path", "url": "https://security-explorations.com/microsoft-warbird-pmp.html", "domain": "security-explorations.com", "votes": 1, "user": "frozenice", "posted_at": "2024-04-24 08:50:37", "comments": 0, "source_title": "Security Explorations - Microsoft Warbird and PMP", "source_text": "Security Explorations - Microsoft Warbird and PMP\n\n  * About Us\n  * Research\n  * Newsroom\n  * Media\n  * Contact\n\n#### Research\n\n  * Mobile Java and Nokia phones\n\n    * General info\n    * Project newsroom\n    * Faq\n  * Digital satellite TV platform\n\n    * General info\n    * Project newsroom\n    * Faq\n    * PoC Codes\n    * Details\n    * Vendor\n  * Java Se\n\n    * General info\n    * Project newsroom\n    * Faq\n    * PoC Codes\n    * Details\n    * Vendor\n  * Oracle Java Cloud Service\n\n    * General info\n    * Project newsroom\n    * Faq\n    * Details\n    * Vendor\n  * Oracle Database Java VM\n\n    * General info\n    * Project newsroom\n    * Faq\n    * PoC Codes\n    * Details\n    * Vendor\n  * Google App Engine for Java\n\n    * General info\n    * Project newsroom\n    * Faq\n    * Details\n    * Vendor\n  * ST DVB Chipsets\n\n    * General info\n  * NC+ SAT TV Platform\n\n    * General info\n    * Project newsroom\n  * Java Card\n\n    * General info\n    * Project newsroom\n    * Faq\n    * Details\n    * Vendor\n  * Microsoft PlayReady\n\n    * General info\n    * Details\n  * Cinterion IoT devices\n\n    * General info\n    * Details\n  * Microsoft Warbird and PMP\n\n    * General info\n    * Details\n\n# Microsoft Warbird and PMP\n\n  * Choose a project\n\n    * Mobile Java and Nokia phones\n\n      * General info\n      * Project newsroom\n      * Faq\n    * Digital satellite TV platform\n\n      * General info\n      * Project newsroom\n      * Faq\n      * PoC Codes\n      * Details\n      * Vendor\n    * Java SE\n\n      * General info\n      * Project newsroom\n      * Faq\n      * PoC Codes\n      * Details\n      * Vendor\n    * Oracle Java Cloud Service\n\n      * General info\n      * Project newsroom\n      * Faq\n      * Details\n      * Vendor\n    * Oracle Database Java VM\n\n      * General info\n      * Project newsroom\n      * Faq\n      * PoC Codes\n      * Details\n      * Vendor\n    * Google App Engine for Java\n\n      * General info\n      * Project newsroom\n      * Faq\n      * Details\n      * Vendor\n    * ST DVB Chipsets\n\n      * General info\n    * NC+ SAT TV Platform\n\n      * General info\n      * Project newsroom\n    * Java Card\n\n      * General info\n      * Project newsroom\n      * Faq\n      * Details\n      * Vendor\n    * Microsoft PlayReady\n\n      * General info\n      * Details\n    * Cinterion IoT devices\n\n      * General info\n      * Details\n    * Microsoft Warbird and PMP\n\n      * General info\n      * Details\n\n## General info\n\nIn a result of its research investigation efforts, Security Explorations, a\nresearch lab of AG Security Research company, conducted security analysis of\nMicrosoft Warbird and Protected Media Path technologies.\n\nThis section of our website presents initial information regarding the\nproject.\n\n### Microsoft Warbird and Protected Media Path description\n\nMicrosoft Protected Media Path (PMP) is a set of technologies of which goal is\nto enforce security of content (security of PlayReady DRM) in a Windows OS\nenvironment (Wikipedia).\n\nIn Windows OS, Protected Media Path is implemented both in kernel and user\nspace. It relies on crypto, code integrity, auth checks, whitebox crypto and\ncode obfuscation.\n\nMicrosoft Warbird is a compiler technology from Microsoft of which goal is to\nmake reverse engineering (such as static and dynamic analysis) of code\ncomponents comprising certain Windows OS components hard. More specifically,\nthe goal is to make it hard to extract secrets pertaining to code\nimplementation in an untrusted (under attacker's control) environment.\n\nBinaries produced by Warbird can be encrypted and its code obfuscated. These\nbinaries can execute \"encrypted\" code too.\n\n### Demonstration movies\n\n  * \"Content key sniffing, arbitrary movie download and decryption (Canal+ Online VOD scenario, Win10 SW DRM)\", MP4 movie file, 32MB\n\n  * \"Content key sniffing for Netflix (Win10 SW DRM)\", MP4 movie file, 10MB\n\n### Notes\n\nAs a result of the research several deficiencies have been discovered in\nvarious PMP components, which could be exploited to gain access to plaintext\ncontent keys guarded by PlayReady (Windows 10 / Windows 11 environment and SW\nDRM case).\n\nIt has been demonstrated that these plaintext keys could be successfully used\nto decrypt high definition (1080p) movies protected by PlayReady content\nprotection (Canal+ Online VOD platform scenario).\n\nOn Windows platforms with HW DRM capability, the attack can still proceed as\nthis feature can be easily disabled. Also, none of the streaming platforms\ntested enforced HW DRM for Windows (with HW DRM disabled, SW DRM was used and\ncontent key extraction could proceed both in Windows 10 and 11).\n\nThe root cause of the issue lies in SW DRM implementation used by default on\nWindows 10 without HW DRM capability. This version of Microsoft OS still (as\nof Mar 2024) has a 69% market share worldwide, which is partially caused by\ninability for users to upgrade to Windows 11 as their systems do not meet\nminimum upgrade requirements, such as having a TPM 2.0 chip. Windows 10 is set\nto retire on Oct 14, 2025. As such, a potential weak chain is to still persist\nfor 1.5 year (due to the implementation done solely in SW, on a client side\nand in an environment under attacker's control).\n\nPlease, note that this is a different research than our research from 2022\n(and different Canal+ VOD service). The results and know-how obtained by this\nnew research make the previous research obsolete in many ways.\n\n### Content security as part of a security field\n\nDRM technology lies at the core of a security of the industry that is valued\nat $544 billion.\n\nIn that context, content security should not be different than the usual\ninformation security safeguarding organizations' trade secrets, IT assets or\npersonal data.\n\nExposure of the weaknesses or false security claims in the PayTV / video\nstreaming / content security industry is equally important too.\n\nThis research is a continuation of our journey spanning 12 years during which\nwe investigated security of PayTV / content security systems such as DVB\nchipsets / Conax Conditional Access System, SAT TV Platforms, set-top-boxes /\nVOD platforms and implementation of a DRM system.\n\n### Microsoft seeking details\n\nOn Apr 12, 2024, Microsoft PlayReady team reached to us with a request to\nreport technical details and POC code through MSRC channel claiming that \"by\nfollowing the MSRC process to report your finding, it may be eligible for a\nreward\" and that \"close partnerships with the researcher community make\ncustomers more secure and we play an integral role by sharing issues under\nCoordinated Vulnerability Disclosure\").\n\nAs a response, we informed Microsoft that we cannot provide the company with\nadditional details / codes pertaining to our PlayReady security research on\nWindows as this can only happen through a commercial agreement, not MSRC\nreporting channel (Apr 15, 2024).\n\nThe rationale for it is quite simple. The research took us nearly 9 months of\nwork (on top of the 6 months of R&D done in 2022, which has been \"consumed\"\nand in some way ignored by the company).\n\nThe new research embeds some potentially valuable IP / know-how, which we need\nto protect too (see \"Additional materials\" paragraph describing potentially\nunauthorised, commercial use of our original idea for a rogue subscriber\ndetection / deactivation). Finally, disclosure of our know-how / toolset to\nMicrosoft might jeopardize our future projects targeting Windows OS platform.\n\nIf we decide to release any additional details, Microsoft will learn about\nthese from a public source (this page in particular) and completely for free.\n\nWe believe the above should not impose any limits for Microsoft when it comes\nto the work aimed at making PlayReady on Windows more secure (vide details\nposted and access to all the know-how and engineering resources at company's\nend).\n\nWe also believe the final outcome can be only positive too. Instead of\nlimiting its focus on a single attack, Microsoft needs to conduct a more\ncomprehensive review of Protected Media Path environment. Such an approach\nusually results in a discovery / fixing of additional issues.\n\n### Affected streaming platforms\n\nOur tests indicate that the following streaming platforms are affected:\n\n    * Canal+ Online\n    * Netflix\n    * HBO Max\n    * Amazon Prime Video\n    * Sky Showtime\n\nClick to show sample keys\n\n    \n        [CANAL+ ONLINE] - \"Boska Florence\" movie * key id: d4710165a17e7f4ab6f0973e9bb8c723 * content key: 04xxxxxxxxxxxxxxxxxxxxxxxxxxxxxx * key SHA256: c37da9b9500501a429ed038a6bf037df079a69aefdbcee873f2414089d51882b [NETFLIX] - \"Znachor\" movie * key id: 000000000d08e3ad0000000000000000 * content key: 05xxxxxxxxxxxxxxxxxxxxxxxxxxxxxx * key SHA256: 575be54d30952cc4bd8bad70a02881b17c0c40ca866820fdd25f974411bd7933 [HBO MAX] - \"Wonka\" movie * key id: a71200013eac3e9c3daa91a3a8add795 * content key: 2fxxxxxxxxxxxxxxxxxxxxxxxxxxxxxx * key SHA256: f78327b138bb420943ac120c64d6e686e1497dc52d52456425008c5fd5653e07 * key id: 67c40101d46944e3681a799fea6b8910 * content key: 8dxxxxxxxxxxxxxxxxxxxxxxxxxxxxxx * key SHA256: c7887d72c236ef0a429c2a9c31060c60913e65044359680054eb19bdae2b208f [AMAZON PRIME VIDEO] - \"Otto\" movie * key id: cfda70a8a6281a45aad9d2b302666e76 * content key: 97xxxxxxxxxxxxxxxxxxxxxxxxxxxxxx * key SHA256: 14c70783c63f7bbfe890910dbf7c9d46d9fd5a7f2b8a9e7acdd67be33d6ddc1b [SKY SHOWTIME] - \"Oppenheimer\" movie * key id: 54c80000fdcbea6d30fef35c21939ef9 * content key: 45xxxxxxxxxxxxxxxxxxxxxxxxxxxxxx * key SHA256: 1c879cfb86e4c58e6ee147cdccbd86587cb8f04edfcbbcf06ffa32775d7443b2\n\nThe keys above should constitute a sufficient prove for the platforms\nmentioned to be able to confirm the attack.\n\nAll licenses received during testing were issued with SL2000 security level,\nwhich indicate the default presence of \"Software-DRM Clients\" on Windows 10\nand 11 (clients backed mostly with software means, secrets protected through\nsoftware or hardware means).\n\nTaking into account the technique used to extract plaintext value of content\nkeys, we assume that key extraction might also work for some other platforms\nrelying on SW Microsoft PlayReady technology in a Windows OS environment (VOD\nand Live TV services). We verified it to work for Canal+ Live TV services and\nthe following live TV channels available through it:\n\n    * Disney Channel\n    * CNBC\n    * CNN\n    * BBC News\n    * Warner TV\n    * Paramount Channel\n\nIn general, the ability to extract plaintext value of a content key from a DRM\nsystem constitutes a base for considering it to be compromised. This is\nespecially valid taking into account the amount of efforts at Microsoft end\n(vide 10 years of innovation and more than $1B invested) to make it hard to\nconduct static and dynamic analysis of PlayReady operation on Windows\nplatform.\n\n### Attack summary\n\nThe attack scenario makes it possible to extract plaintext values of content\nkeys from a Protected Media Path process. The attack proceeds by exploiting a\ntime window during which content keys have a XORed form - the plaintext value\nof such keys can be obtained by the means of a simple XOR operation with a\nmagic 128-bit key sequence.\n\nOur tests indicate that there are only two such magic key sequences used\nacross Windows OS versions released since 2022 (one for Windows 10, the other\nfor Windows 11).\n\nThe above has been confirmed on Windows 10 / 11 x64 systems across various\nbuilds from late 2022 till Apr 2024 (systems without and with HW DRM\ncapability):\n\n#### XOR_KEY_1\n\n    * Windows 10 22H2 build 19045.1889 (Aug 2022)\n    * Windows 10 22H2 build 19045.2364 (Dec 2022)\n    * Windows 10 22H2 build 19045.2728 (Mar 2023)\n    * Windows 10 22H2 build 19045.3086 (Jun 2023)\n    * Windows 10 22H2 build 19045.3448 (Sep 2023)\n    * Windows 10 22H2 build 19045.3803 (Dec 2023)\n    * Windows 10 22H2 build 19045.4170 (Mar 2024)\n    * Windows 10 22H2 build 19045.4291 (Apr 2024)\n\n#### XOR_KEY_2\n\n    * Windows 11 22H2 build 22621.521 (Sep 2022)\n    * Windows 11 22H2 build 22621.963 (Dec 2022)\n    * Windows 11 22H2 build 22621.1413 (Mar 2023)\n    * Windows 11 23H2 build 22631.3296 (Mar 2024)\n    * Windows 11 23H2 build 22631.3447 (Apr 2024)\n\n### Identity and license store theft\n\nWe verified that content key extraction can be also performed in an offline\nmanner. What is needed for that purpose are the encrypted license blobs and a\nclient identity file.\n\nIn that context, a theft of a client identity and accompanying license store\nfiles from a user system does constitute a potential risk too (Windows 10 / 11\nand SW DRM scenario).\n\n### Public CDN access\n\nThe risk related to unauthenticated Content Delivery Network (CDN) has been\nsignalled by us at the time of 2022 research. Yet, we noticed that some\nproviders still rely on publicly available CDN (Canal+ and Orange Web Cache\nscenario).\n\nPublic CDN makes it difficult to detect anomalous and/or unauthorised download\nbehaviours.\n\nEven though the content is encrypted, it does carry valuable information. A\nleak or extraction of a content key (such as demonstrated through this\nresearch) may result in the information to become immediately decrypted and\ncompromised.\n\nThe above makes protection of content keys even more important (and content\nkeys extraction even more severe).\n\n### Possible mitigations\n\nStreaming / VOD platforms that are either dissatisfied with PlayReady security\nor would like to implement a temporary mitigation might consider transition to\n/ enforcement of other widely supported (by web browsers applications) content\nprotection technologies.\n\n### Research impact\n\nThe research shows that the underlying technology such as Microsoft PlayReady\ncan constitute a significant weak point. As such, it should not be ignored if\nstreaming platforms are concerned about security of content.\n\nOne needs to keep in mind that a cost for a streaming platform subscription is\nin the range of 10-15 EUR (Poland). But, streaming platforms need to secure\nassets, which in some cases can generate nearly a billion in profits alone\n(vide Oppenheimer movie Box Office data, of which key is part of the posted\nkey samples).\n\nThe attack that is able to extract content keys to premium movies for an\narbitrary streaming platform requires just one rogue subscriber.\n\nContent key extraction is also one of the worst things that can happen from a\ncontent security point of view as extracted keys can be shared online, they\ncan be used to access premium video content without paying a subscription fee\nor decrypt and distribute movies over the Internet. Content key extraction and\nits impact is further explained in this blog post.\n\n### Potential disruptions in services reception\n\nSome changes have been observed and information received with respect to\n\"Terms of Use\" service agreements of some streaming platforms / video\nservices.\n\nOn 23 Apr 2024, a message has been received from Sky Showtime (to e-mail\nsubscription address), which informs about changes to the terms of use of the\nservice. The new terms seem to free Sky Showtime from a responsibility\n(liability) related to no reception of the programming (service) and no\nsupport for old applications versions (users might need to apply latest\napplication / OS upgrades in order to be able to continue using Sky Showtime\nstreaming services).\n\nIt's also worth to mention that Sky Terms and Conditions have a separate\n\"Microsoft PlayReady Notice\" stating that \"if the PlayReady technology fails\nto protect the content, content owners may require the service to restrict or\nprevent the delivery of protected content to specified devices or PC software\napplications\".\n\nThe above could implicate potential disruptions in some streaming services\nreception occurring as a result of a delivery of a fix / mitigation for this\n(or future) DRM hack or a switch off of the affected content protection\ntechnology.\n\n## Details\n\nThe following technical materials are available with respect to the security\nanalysis conducted for Microsoft Warbird and PMP technologies.\n\n### Materials\n\n  * \"Warbird Reverse Engineering toolkit\" Standalone toolkit making it possible to investigate Warbird protected binary files and facilitating their static and dynamic analysis. The toolkit makes is possible to perform dynamic analysis of arbitrary PlayReady functionality such as individualization, license acquisition or license blob decryption (content key decryption), private ECC key discovery, XOR key discovery, etc.\n  * \"Content key sniffer\" The tool making it possible to extract plaintext values of content keys from Protected Media Path process (SW DRM on Windows 10 / 11 case).\n  * \"Test LS\" Simple PlayReady License Server with a basic functionality to handle PlayReady individualization and license acquisition requests.\n  * \"MSPR Toolkit update\" An update to MSPR toolkit supporting sniffer data import and dump along reverse engineering support for XOR key discovery\n\nCopyright \u00a9 2024 Security Explorations | In idea we trust: Ministerstwo Idei\n\n", "frontpage": false}
