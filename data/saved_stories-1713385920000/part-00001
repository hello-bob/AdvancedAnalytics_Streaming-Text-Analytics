{"aid": "40065166", "title": "GitHub \u2013 antirez/zx2040: RP2040 ZX Spectrum emulator", "url": "https://github.com/antirez/zx2040", "domain": "github.com/antirez", "votes": 5, "user": "rcarmo", "posted_at": "2024-04-17 14:30:08", "comments": 0, "source_title": "GitHub - antirez/zx2040: RP2040 ZX Spectrum emulator", "source_text": "GitHub - antirez/zx2040: RP2040 ZX Spectrum emulator\n\nSkip to content\n\nSign in\n\n# Search code, repositories, users, issues, pull requests...\n\nSearch syntax tips\n\nSign in\n\nSign up\n\nYou signed in with another tab or window. Reload to refresh your session. You\nsigned out in another tab or window. Reload to refresh your session. You\nswitched accounts on another tab or window. Reload to refresh your session.\nDismiss alert\n\nantirez / zx2040 Public\n\n  * Notifications\n  * Fork 0\n  * Star 20\n\nRP2040 ZX Spectrum emulator\n\n### License\n\nMIT license\n\n20 stars 0 forks Branches Tags Activity\n\nStar\n\nNotifications\n\n# antirez/zx2040\n\nThis commit does not belong to any branch on this repository, and may belong\nto a fork outside of the repository.\n\n1 Branch\n\n0 Tags\n\n## Folders and files\n\nName| Name| Last commit message| Last commit date  \n---|---|---|---  \n  \n## Latest commit\n\nantirezREADME: minor form fixes.Apr 17, 2024dcb2940 \u00b7 Apr 17, 2024Apr 17, 2024\n\n## History\n\n95 Commits  \n  \n### devices\n\n|\n\n### devices\n\n| Self commented example device configuration.| Apr 16, 2024  \n  \n### games\n\n|\n\n### games\n\n| Program to generate complete UF2 images.| Apr 17, 2024  \n  \n### images\n\n|\n\n### images\n\n| Add image into README.| Apr 17, 2024  \n  \n### uf2-append\n\n|\n\n### uf2-append\n\n| Program to generate complete UF2 images.| Apr 17, 2024  \n  \n### uf2\n\n|\n\n### uf2\n\n| Program to generate complete UF2 images.| Apr 17, 2024  \n  \n### .gitignore\n\n|\n\n### .gitignore\n\n| Program to generate complete UF2 images.| Apr 17, 2024  \n  \n### CMakeLists.txt\n\n|\n\n### CMakeLists.txt\n\n| Audio: dual-core audio implementation.| Apr 12, 2024  \n  \n### LICENSE\n\n|\n\n### LICENSE\n\n| License file.| Apr 4, 2024  \n  \n### README.md\n\n|\n\n### README.md\n\n| README: minor form fixes.| Apr 17, 2024  \n  \n### TODO.md\n\n|\n\n### TODO.md\n\n| Program to generate complete UF2 images.| Apr 17, 2024  \n  \n### chips_common.h\n\n|\n\n### chips_common.h\n\n| ZX Specturm emulator port for Pico: initial commit.| Mar 27, 2024  \n  \n### clk.h\n\n|\n\n### clk.h\n\n| ZX Specturm emulator port for Pico: initial commit.| Mar 27, 2024  \n  \n### kbd.h\n\n|\n\n### kbd.h\n\n| ZX Specturm emulator port for Pico: initial commit.| Mar 27, 2024  \n  \n### keymaps.h\n\n|\n\n### keymaps.h\n\n| README rewritten. Valley of rain updated for copyright issues.| Apr 16, 2024  \n  \n### mem.h\n\n|\n\n### mem.h\n\n| ZX Specturm emulator port for Pico: initial commit.| Mar 27, 2024  \n  \n### pico_sdk_import.cmake\n\n|\n\n### pico_sdk_import.cmake\n\n| ZX Specturm emulator port for Pico: initial commit.| Mar 27, 2024  \n  \n### st77xx.h\n\n|\n\n### st77xx.h\n\n| Audio: dual-core audio implementation.| Apr 12, 2024  \n  \n### z80.h\n\n|\n\n### z80.h\n\n| Z80: add hl,hl speedup.| Apr 15, 2024  \n  \n### zx-roms.h\n\n|\n\n### zx-roms.h\n\n| ZX Specturm emulator port for Pico: initial commit.| Mar 27, 2024  \n  \n### zx.c\n\n|\n\n### zx.c\n\n| Audio: change default wait after Z80 speedups.| Apr 16, 2024  \n  \n### zx.h\n\n|\n\n### zx.h\n\n| Z80: speedup WIP 2: memory access.| Apr 15, 2024  \n  \n## Repository files navigation\n\nThe ZX2040 is a port of Andre Weissflog ZX Spectrum emulator to the Raspberry\nPico RP2040, packed with a simple UI for game selection and key mapping to\nmake it usable without a keyboard.\n\nThis project is specifically designed for the Raspberry Pico and ST77xx based\ndisplays. Our reference device is the Pimoroni Tufty RP2040 display board, but\nactually the code can run into any Raspberry Pico equipped with an ST77x\ndisplay and five buttons connected to five different pins. The buttons work as\ninputs for the four gaming directions (left, right, top, bottom) and the fire\nbutton. Please refer to the hardware section for more information.\n\n## Main features\n\n  * Pico -> Spectrum key mapping with each pin mapped up to two Specturm keys or Kempstone joystick moves. Each game has its own key map, taking advantage of mapping to make games easier to play on portable devices: for instance Jetpac maps a single key (down key) to up + fire. Key macros are used in order to automatically trigger key presses when given frames are reached, to select the kempstone joystick, skip key redefinition, and other things otherwise impossible with few buttons available on the device.\n  * A minimal ST77xx display driver is included, written specifically for this project. It has just what it is needed to initialize the display and refresh the screen with the Spectrum frame buffer content. It works both with SPI and 8-wires parallel interfaces and is optimized for fast bulk refreshes.\n  * The emulator has an UI that allows to select games into a list, change certain emulation settings and so forth.\n  * Multiple games included, with a script to easily added more (see section about adding games). Important, I included copyrighted games hoping that's fair-use, since these games are no longer sold. If you are the copyright owner and want the game to be removed, please open an issue or write me an email at antirez at google mail service.\n  * Real time upscaling and downscaling of video, to use the emulator with displays that are larger or smaller than the Spectrum video output. The emulator is also able to remove borders.\n  * Crazy overclocking to make it work fast enough :D Warning: the code must run from the Pico RAM, and not in the memory mapped flash, otherwise it's not possible to go at 400Mhz. This is achieved simply with pico_set_binary_type(zx copy_to_ram) in CMakeList.txt. There are no problems accessing the flash to load games, because the code down-clocks the CPU when loading games, and then returns at a higher overclocking speeds immediately after.\n\n## Changes made to the original emulator\n\nThe fantastic emulator I used as a base for this project was not designed for\nvery small devices. It was rather optimized for the elegance of the\nimplementation (you have self-contained emulated chips that are put together\nwith the set of returned pins states) and very accurate emulation. To make it\nrun on the Pico, I had to modify the emulator in the following ways:\n\n  * In order to work with the small amount of RAM available in the RP2040, only the Spectrum 48k version is emulated, the 128k code was removed. The video code was changed to use a much smaller CRT frame buffer, where each byte holds two pixels (4bpp color).\n  * The emulator UI is rendered directly on the emulator frame buffer in order to save memory.\n  * Emulation performances were improved by rewriting small parts of the code that renders the ZX Spectrum VMEM into the CRT frame buffer (ULA emulation) and modifying the Z80 implementation to cheat a bit (well, a lot): many steps of instruction fetching were combined together, slow instructions executed in less cycles, memory accesses done directly inside the Z80 emulation tick, and so forth. This makes the resulting emulator no longer cycle accurate, but otherwise we could go at best at 60% of the speed of real hardware, which is not enough.\n  * Audio support was completely rewritten using the Pico second core and double buffering. We have two issues with the RP2040. One is memory. Fortunately there is no need to go from 1 bit music to 16bit samples that will then drive a speaker exactly with 1 bit of actual resolution. It makes sense in the original emulator, since the audio device of a real computer will accept proper 16 bit audio samples, but in the Pico we just drive a pin with a connected speaker. So this repository implements a bitmap audio buffer, reducing the memory usage by a factor of 32. Another major problem is that we are emulating the Spectrum native speed by running without pauses: there is no way to be sure about the exact timing of a full tick (different sequences of instructions run at different speed), and the audio must be played as it is produced (in the original emulator it was assumed that the CPU of the host computer was able to emulate the Spectrum much faster, take the audio buffer, and put the samples in the audio output queue). So I used double buffering, and as the Z80 produces the music we play the other half of the buffer in the other thread, with adaptive timing. The result is recognizable audio even if the quality is not superb.\n\nWith this changes, when the Pico is overclocked at 400Mhz (default of this\ncode, with cpu voltage set to 1.3V), the emulation speed is more or less the\nsame as a real ZX Spectrum 48K in most games. If you want to go slower\n(simpler to play games, and certain Picos may not run well at 400Mhz) press\nthe right button when powering up: this will select 300Mhz.\n\n## Motivations for this project\n\nThe ZX Spectrum was the computer where I learned to code when I was a child.\nBefore owning the Spectrum, I used to play with my father's computer, a TI\n99/4A, yet the Spectrum was my first real computer, and the one where I wrote\nmy first decent programs. So part of this is nostalgia.\n\nOn a more practical way, I wanted an emulator that was a good fit for the Pico\nand specifically conceived to run with cheap displays, able to easily be\nadapted to different displays resolutions, MIT licensed, very easy to hack on.\nSo that people can build, enjoy and even sell if they want battery-powered\nsmall cheap Spectrum. This can help to make the ZX Spectrum heritage last more\nin the future.\n\nFinally, I needed to explore a bit more the Pico SDK and its C development\nexperience. Recently I'm doing embedded programming, and the RP2040 is one of\nthe most interesting MCUs out there. Writing this code was extremely helpful\nto better understand the platform.\n\n## Credits\n\nI want to thank Andre Weissflog for writing the original code and let us dream\nagain. If this project was possible it is 90% because of his work.\n\n## Hardware needed\n\nYou need either:\n\n  * A Pimoroni Tufty 2040.\n  * Or, any other suitable Pico + display + 5 buttons combination.\n\nand...\n\n  * A piezo speaker if you want audio support.\n\nThis project only supports ST77xx displays so far. They are cheap and\nwidespread, and they work well and exist in different qualities: TFT, IPS, and\nso forth.\n\nA note of warning: it is crucial to be able to refresh the display fast\nenough. SPI displays work well if they are not huge, let's say that up to\n320x240 max the update latency will not be so terrible.\n\nParallel 8-lines ST77xx displays are much better, for instance in the Tufty\n2040, using upscaling, it is possible to transfer the Spectrum CRT frame\nbuffer to the display in something like ~14 milliseconds, so even refreshing\nthe display ~20 times per second we have 700 milliseconds of CPU time to run\nthe emulator itself.\n\n320x240 displays are particularly good because the Spectrum full visible area\nincluding borders is 320x256 pixels, so when borders are enabled this is a\nnice view. When borders are disabled, it's even better: the bitmap resolution\nof the Spectrum is 256x192 pixels, it means that using 125% upscaling we match\nexactly the 320x240 display resolution!\n\nThe display should also be big enough if you want a nice play experience.\nSpectrum games were designed to be displayed in a big TV set, so certain\ndetails can be too small if very small displays are used. 2.4\" is a nice size.\nLarger is even better.\n\n## Installation from sources\n\nIf you build from sources:\n\n  * Create a device_config.h file in the main directory. For the Pimoroni Tufty 2040 just do cp devices/tufty2040.h device_config.h. Otherwise if you have some different board, or you made one by hand with a Pico and an ST77xx display, just check the self-commented example file under the devices directory and create a configuration for your setup: it's easy, just define your pins and the display interface (SPI/parallel).\n  * Compile with: mkdir build; cd build; cmake ..; make.\n  * Transfer the zx.uf2 file to your Pico (put it in boot mode pressing the boot button as you power up the device, then drag the file in the RPI-RP2 drive you see as a USB drive).\n  * Transfer the games images on the flash. Enter the games directory, put the Pico in boot mode (again) and run the loadgames.py Python program. Note that you need picotool installed (pip install picotool, or alike) to run it.\n\n## Installation from pre-built images\n\nIf you have a Tufty 2040, you can just grab one of the images under the uf2\ndirectory in this repository and flash your device. Done.\n\nIf you want to create pre-built images with more games or for other devices,\ncheck the UF2 merge program under the uf2-append directory. There is a README\ninside, that explains how to use the program.\n\n## Usage\n\n  * Select the game and press the fire button to load it. The press the fire button again with the loaded game selected to leave the menu.\n  * Long press left+right to return back to the menu.\n  * Start with the left button pressed for more serial debugging and frame counter.\n  * Start with the right button pressed to boot with a less extreme overclocking (300Mhz instead of 400Mhz). You can adjust it from the menu.\n\n## Included games\n\n  * Jetpac\n  * Loderunner\n  * International Karate+\n  * Sabre Wulf\n  * Sanxion\n  * Scuba Dive\n  * Thrust\n  * BMX Simulator\n  * Bombjack\n  * Skool Daze\n\n## Included demos\n\n  * 3D Show (19xx), Vektor Graphix.\n\n## Games keymaps\n\nIf you have doubts about what keys to use for a given file, make sure to check\nthe keymaps.h file inside this repository. There you will find a keymap for\neach game, with comments telling you what each key does what and why.\n\n## Adding games\n\n  1. Copy the game Z80 file into the games directory. Use a very short name without special characters.\n  2. Generate the game table and load the new binary image of the games using the loadgames.py script. Before running the script, put the Pico in boot mode.\n  3. Add a keymap for the game, editing the keymaps.h file using the other keymaps as example.\n  4. Recompile the project.\n  5. Transfer the new UF2 image to the Pico.\n\n## Using this emulator for commercial purposes\n\nAll the code here MIT licensed, so you are free to use this emulator for\ncommercial purposes. Feel free to sell it, put it as example in your boards or\nwhatever you want to do with it. However please note that the include games\nare copyrighted material and are not under a free license. Either use free\nsoftware games with a suitable license (there are new games developed for the\nSpectrum every year, very cool ones too: pick the ones with a suitable\nlicense), or if you include the games in this repository in a commercial\nproduct you will be responsible for your actions, not me :).\n\nOne thing is the fair-use of redistributing things for free, given that nobody\nis selling these games anymore. But making money with them is a different\nstory I believe.\n\n## About\n\nRP2040 ZX Spectrum emulator\n\n### Resources\n\nReadme\n\n### License\n\nMIT license\n\nActivity\n\n### Stars\n\n20 stars\n\n### Watchers\n\n1 watching\n\n### Forks\n\n0 forks\n\nReport repository\n\n## Releases\n\nNo releases published\n\n## Packages 0\n\nNo packages published\n\n## Languages\n\n  * C 99.0%\n  * Other 1.0%\n\n## Footer\n\n\u00a9 2024 GitHub, Inc.\n\nYou can\u2019t perform that action at this time.\n\n", "frontpage": true}
