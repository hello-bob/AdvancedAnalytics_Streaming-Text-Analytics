{"aid": "40141415", "title": "Fedora 40: Changes/Unified Kernel Support Phase 2", "url": "https://fedoraproject.org/wiki/Changes/Unified_Kernel_Support_Phase_2", "domain": "fedoraproject.org", "votes": 1, "user": "doener", "posted_at": "2024-04-24 06:47:30", "comments": 0, "source_title": "Changes/Unified Kernel Support Phase 2 - Fedora Project Wiki", "source_text": "Changes/Unified Kernel Support Phase 2 - Fedora Project Wiki\n\n  * Links\n\n    * Get Fedora\n    * Fedora Docs\n    * Fedora Magazine\n    * What Can I Do?\n  * CodeOfConduct\n\n    * Code of Conduct\n  * Subprojects\n\n    * Ambassadors\n    * Community Operations\n    * Design\n    * Documentation\n    * EPEL\n    * Infrastructure\n    * Internationalization\n    * Localization\n    * Marketing\n    * Magazine\n    * Package Maintainers\n    * Quality Assurance\n    * Websites\n    * All projects\n\nLog In\n\n# Changes/Unified Kernel Support Phase 2\n\nThis page was last edited on 28 February 2024, at 20:50.\n\n  * Page\n  * Discussion\n  * Read\n  * View source\n  * View history\n\nFrom Fedora Project Wiki\n\n< Changes\n\n## Contents\n\n  * 1 Unified Kernel Support Phase 2\n\n    * 1.1 Summary\n    * 1.2 Owner\n    * 1.3 Current status\n    * 1.4 Detailed Description\n\n      * 1.4.1 Phase 2 goals\n      * 1.4.2 Related bugs + merge requests\n    * 1.5 Feedback\n    * 1.6 Benefit to Fedora\n    * 1.7 Scope\n    * 1.8 Upgrade/compatibility impact\n    * 1.9 How To Test\n\n      * 1.9.1 Switch an existing install to use UKIs.\n      * 1.9.2 Test UKI cloud images (new: kiwi)\n      * 1.9.3 Test UKI cloud images (old: kickstart)\n      * 1.9.4 Booting another kernel\n    * 1.10 User Experience\n    * 1.11 Dependencies\n    * 1.12 Contingency Plan\n    * 1.13 Documentation\n    * 1.14 Release Notes\n\n# \ud83d\udd17 Unified Kernel Support Phase 2\n\n## \ud83d\udd17 Summary\n\nImprove support for unified kernels in Fedora.\n\n## \ud83d\udd17 Owner\n\n  * Name: Gerd Hoffmann\n  * Email: kraxel@redhat.com\n\n  * Name: Vitaly Kuznetsov\n  * Email: vkuznets@redhat.com\n\n## \ud83d\udd17 Current status\n\n  * Targeted release: Fedora Linux 40\n  * Last updated: 2024-02-28\n  * Announced\n  * Discourse Thread\n  * FESCo issue: #3123\n  * Tracker bug: #2258073\n  * Release notes tracker: #1100\n\n## \ud83d\udd17 Detailed Description\n\nSee Changes/Unified_Kernel_Support_Phase_1 for overview and Phase 1 goals.\n\n#### \ud83d\udd17 Phase 2 goals\n\n  * Add support for booting UKIs directly.\n\n    * Boot path is shim.efi -> UKI, without any boot loader (grub, sd-boot) involved.\n    * The UEFI boot configuration will get an entry for each kernel installed.\n    * Newly installed kernels are configured to be booted once (via BootNext).\n    * Successful boot of the system will make the kernel update permanent (update BootOrder).\n  * Enable UKIs for aarch64.\n\n    * Should be just flipping the switch, dependencies such as kernel zboot support are merged.\n  * Add a UEFI-only cloud image variant which uses UKIs.\n\n    * Also suitable for being used in confidential VMs.\n    * Cover both x86_64 and aarch64.\n    * Related: Changes/KiwiBuiltCloudImages\n\n#### \ud83d\udd17 Related bugs + merge requests\n\n  * shim: remove dependency on grub2-efi-x64 (buzilla 2240989)\n  * shim: handling of multiple lines in BOOT.CSV is inconsistent (jira RHEL-10704, github 554)\n  * anaconda: add support for discoverable partitions (bugzilla 2160074, bugzilla 2178043)\n  * dracut: do not create yet another initramfs for UKIs (github PR 2521)\n  * kernel: enable UKIs on aarch64 (MR 2818)\n  * fedora-kiwi-descriptions: add Cloud-Base-UEFI-UKI profile (PR #9)\n\n## \ud83d\udd17 Feedback\n\n## \ud83d\udd17 Benefit to Fedora\n\n  * Better secure boot support: the UKI initrd is covered by the signature.\n  * Better support for tpm measurements and confidential computing.\n\n    * measurements are more useful if we know what hashes to expect for the initrd.\n    * measurements are more useful without grub.efi in the boot path (which measures each grub.cfg line processed).\n  * More robust boot process\n\n    * generating the initrd on the installed system is fragile\n\n## \ud83d\udd17 Scope\n\n  * Proposal owners:\n\n    * updates for virt-firmware and uki-direct packages.\n    * enable UKIs on aarch64 (MR 2818).\n    * prepare kickstart (Fedora kickstarts) changes for generating UKI enabled images.\n\n  * Other developers:\n\n    * installer/anaconda: implement discoverable partition support.\n    * bootloader/shim: fix bugs.\n    * Fedora Cloud SIG: Add UKI enabled images as an option to Download Fedora Cloud\n    * See also: Related Bugs section.\n\n  * Release engineering: #Releng issue number\n\n  * Policies and guidelines: N/A (not needed for this Change)\n\n  * Trademark approval: N/A (not needed for this Change)\n\n  * Alignment with Objectives:\n\n## \ud83d\udd17 Upgrade/compatibility impact\n\nNone, it's opt-in. Also the uefi cloud image is an additional image and will\nnot replace the current bios/uefi hybrid image.\n\n## \ud83d\udd17 How To Test\n\n#### \ud83d\udd17 Switch an existing install to use UKIs.\n\nNeeds up-to-date Fedora 39 or Rawhide install in a virtual machine. Bare metal\nhardware with standard storage (ahci / nvme) should work too.\n\nNeeds an big enough ESP to store UKI images there (minimum 200M, recommended\n500M).\n\n1\\. dnf install virt-firmware uki-direct\n\n  * The uki-direct package contains the kernel-install plugin and systemd unit needed to automatically manage kernel updates.\n  * You should have version 23.10 or newer.\n\n2\\. sh /usr/share/doc/python3-virt-firmware/experimental/fixup-partitions-for-\nuki.sh\n\n  * Workaround for bug 2160074 (anaconda not setting up discoverable partitions).\n  * UKIs need this to find the root filesystem without root=... on the kernel command line.\n\n3\\. dnf install kernel-uki-virt\n\n4\\. kernel-bootcfg --show\n\n  * optional step, shows UEFI boot configuration, the new UKI should be added as BootNext\n\n    \n    \n    $ kernel-bootcfg --show # C - BootCurrent, N - BootNext, O - BootOrder # -------------------------------------------- # N - 0008 - 6.5.7-300.fc39.x86_64 <= entry for the the new kernel # C O - 0007 - 6.5.6-300.fc39.x86_64 <= currently running kernel # O - 0006 - Fedora <= grub2 entry # O - 0001 - UEFI QEMU QEMU HARDDISK [ ... ]\n\n5\\. reboot\n\n6\\. kernel-bootcfg --show\n\n  * optional again, after successful boot the new kernel should be first in BootOrder.\n\n    \n    \n    $ kernel-bootcfg --show # C - BootCurrent, N - BootNext, O - BootOrder # -------------------------------------------- # C O - 0008 - 6.5.7-300.fc39.x86_64 # O - 0007 - 6.5.6-300.fc39.x86_64 # O - 0006 - Fedora # O - 0001 - UEFI QEMU QEMU HARDDISK [ ... ]\n\n#### \ud83d\udd17 Test UKI cloud images (new: kiwi)\n\n  * Clone the fedora-kiwi-descriptions repo, follow instructions to build cloud images locally. The name of the profile is \"Cloud-Base-UEFI-UKI\".\n  * Once the Changes/KiwiBuiltCloudImages proposal is fully implemented and enabled in fedora build infrastructure you should find images on the usual download locations.\n\n    * rawhide\n\n#### \ud83d\udd17 Test UKI cloud images (old: kickstart)\n\nRepo with kickstart files and scripts: https://gitlab.com/kraxel/fedora-uki\n\nImages for download: https://www.kraxel.org/fedora-uki/\n\n  * fedora-uki-cloud: uki-based cloud image, use cloud-init to configure this.\n  * fedora-uki-direct: minimal uki-based image, root password is 'root'.\n  * fedora-classic: minimal non-uki image, root password is 'root'.\n\nKnown problems:\n\n  * images can fail to boot on the first attempt\n\n    * should that happen reset the guest once, the second and all following boots will work fine.\n    * root cause is a shim bug (github 554).\n    * known workaround: add a vTPM to the guest configuration.\n\n#### \ud83d\udd17 Booting another kernel\n\nFrom the booted system:\n\n  * uefi-boot-menu --reboot\n\nFrom the firmware:\n\nIf your UEFI firmware offers an boot menu you should be able to use that to\nselect the kernel to boot. Unfortunately this is not standardized so there is\nno standard procedure to do so.\n\n  * Virtual machines (OVMF): Enter the firmware setup by pressing ESC when you see the tianocore splash screen. Select \"Boot Manager\" in the toplevel menu.\n  * Thinkpad laptops: Interupt normal boot (just 'Enter' on recent hardware, or using the special key on older models), then press F12 (\"choose a temporary startup device\").\n\n## \ud83d\udd17 User Experience\n\n## \ud83d\udd17 Dependencies\n\n## \ud83d\udd17 Contingency Plan\n\n  * Contingency mechanism:\n\n    * drop kickstart file for the uefi-only cloud image.\n  * Contingency deadline: N/A (not a System Wide Change)\n  * Blocks release? No\n\n## \ud83d\udd17 Documentation\n\nN/A (not a System Wide Change)\n\n## \ud83d\udd17 Release Notes\n\nRetrieved from\n\"https://fedoraproject.org/w/index.php?title=Changes/Unified_Kernel_Support_Phase_2&oldid=702106\"\n\nCategories:\n\n  * ChangeAcceptedF40\n  * SelfContainedChange\n\nCopyright \u00a9 2024 Red Hat, Inc. and others. All Rights Reserved. For comments\nor queries, please contact us.\n\nThe Fedora Project is maintained and driven by the community and sponsored by\nRed Hat. This is a community maintained site. Red Hat is not responsible for\ncontent.\n\n  * This page was last edited on 28 February 2024, at 20:50.\n  * Content is available under Attribution-Share Alike 4.0 International unless otherwise noted.\n\n  * Privacy policy\n  * About Fedora Project Wiki\n  * Disclaimers\n  * Code of Conduct\n  * Sponsors\n  * Legal\n  * Trademark Guidelines\n\n", "frontpage": false}
