{"aid": "40162206", "title": "ArcaneDoor \u2013 New espionage-focused campaign found targeting perimeter network de", "url": "https://blog.talosintelligence.com/arcanedoor-new-espionage-focused-campaign-found-targeting-perimeter-network-devices/", "domain": "talosintelligence.com", "votes": 2, "user": "ColinWright", "posted_at": "2024-04-25 19:53:06", "comments": 0, "source_title": "ArcaneDoor - New espionage-focused campaign found targeting perimeter network devices", "source_text": "ArcaneDoor - New espionage-focused campaign found targeting perimeter network\ndevices\n\n# Cisco Talos Blog\n\n# ArcaneDoor - New espionage-focused campaign found targeting perimeter\nnetwork devices\n\nBy Cisco Talos\n\nWednesday, April 24, 2024 11:54\n\nThreat Advisory Threats APT\n\n*Updated 2024-04-25 16:57 GMT with minor wording corrections regarding the targeting of other vendors.\n\nArcaneDoor is a campaign that is the latest example of state-sponsored actors\ntargeting perimeter network devices from multiple vendors. Coveted by these\nactors, perimeter network devices are the perfect intrusion point for\nespionage-focused campaigns. As a critical path for data into and out of the\nnetwork, these devices need to be routinely and promptly patched; using up-to-\ndate hardware and software versions and configurations; and be closely\nmonitored from a security perspective. Gaining a foothold on these devices\nallows an actor to directly pivot into an organization, reroute or modify\ntraffic and monitor network communications. In the past two years, we have\nseen a dramatic and sustained increase in the targeting of these devices in\nareas such as telecommunications providers and energy sector organizations \u2014\ncritical infrastructure entities that are likely strategic targets of interest\nfor many foreign governments.\n\nCisco\u2019s position as a leading global network infrastructure vendor gives\nTalos\u2019 Intelligence and Interdiction team immense visibility into the general\nstate of network hygiene. This also gives us uniquely positioned investigative\ncapability into attacks of this nature. Early in 2024, a vigilant customer\nreached out to both Cisco\u2019s Product Security Incident Response Team (PSIRT)\nand Cisco Talos to discuss security concerns with their Cisco Adaptive\nSecurity Appliances (ASA). PSIRT and Talos came together to launch an\ninvestigation to assist the customer. During that investigation, which\neventually included several external intelligence partners and spanned several\nmonths, we identified a previously unknown actor now tracked as UAT4356 by\nTalos and STORM-1849 by the Microsoft Threat Intelligence Center. This actor\nutilized bespoke tooling that demonstrated a clear focus on espionage and an\nin-depth knowledge of the devices that they targeted, hallmarks of a\nsophisticated state-sponsored actor.\n\nUAT4356 deployed two backdoors as components of this campaign, \u201cLine Runner\u201d\nand \u201cLine Dancer,\u201d which were used collectively to conduct malicious actions\non-target, which included configuration modification, reconnaissance, network\ntraffic capture/exfiltration and potentially lateral movement.\n\n## Critical Fixes Available\n\nWorking with victims and intelligence partners, Cisco uncovered a\nsophisticated attack chain that was used to implant custom malware and execute\ncommands across a small set of customers. While we have been unable to\nidentify the initial attack vector, we have identified two vulnerabilities\n(CVE-2024-20353 and CVE-2024-20359), which we detail below. Customers are\nstrongly advised to follow the guidance published in the security advisories\ndiscussed below.\n\nFurther, network telemetry and information from intelligence partners indicate\nthe actor is interested in \u2014 and potentially attacking \u2014 Microsoft Exchange\nservers and network devices from other vendors. Regardless of your network\nequipment provider, now is the time to ensure that the devices are properly\npatched, logging to a central, secure location, and are configured to have\nstrong, multi-factor authentication (MFA). Additional recommendations specific\nto Cisco are available here.\n\n## Timeline\n\nCisco was initially alerted to suspicious activity on an ASA device in early\n2024. The investigation that followed identified additional victims, all of\nwhich involved government networks globally. During the investigation, we\nidentified actor-controlled infrastructure dating back to early November 2023,\nwith most activity taking place between December 2023 and early January 2024.\nFurther, we have identified evidence that suggests this capability was being\ntested and developed as early as July 2023.\n\nCisco has identified two vulnerabilities that were abused in this campaign\n(CVE-2024-20353 and CVE-2024-20359). Patches for these vulnerabilities are\ndetailed in the Cisco Security Advisories released today.\n\n### Initial Access\n\nWe have not determined the initial access vector used in this campaign. We\nhave not identified evidence of pre-authentication exploitation to date. Our\ninvestigation is ongoing, and we will provide updates, if necessary, in the\nsecurity advisories or on this blog.\n\n## Line Dancer: In-Memory Implant Technical Details\n\nThe malware implant has a couple of key components. The first is a memory-only\nimplant, called \u201cLine Dancer.\u201d This implant is a memory-resident shellcode\ninterpreter that enables adversaries to upload and execute arbitrary shellcode\npayloads.\n\nOn a compromised ASA, the attackers submit shellcode via the host-scan-reply\nfield, which is then parsed by the Line Dancer implant. Note that the use of\nthis field does not indicate the exploitation of CVE-2018-0101 which was NOT\nused as a component of this campaign. The host-scan-reply field, typically\nused in later parts of the SSL VPN session establishment process, is processed\nby ASA devices configured for SSL VPN, IPsec IKEv2 VPN with \u201cclient-services\"\nor HTTPS management access. The actor overrides the pointer to the default\nhost-scan-reply code to instead point to the Line Dancer shellcode\ninterpreter. This allows the actor to use POST requests to interact with the\ndevice without having to authenticate and interact directly through any\ntraditional management interfaces.\n\nLine Dancer is used to execute commands on the compromised device. During our\ninvestigation, Talos was able to observe the threat actors using the Line\nDancer malware implant to:\n\n  * Disable syslog.\n  * Run and exfiltrate the command show configuration.\n  * Create and exfiltrate packet captures.\n  * Execute CLI commands present in shellcode; this includes configuration mode commands and the ability to save them to memory (write mem).\n  * Hook the crash dump process, which forces the device to skip the crash dump generation and jump directly to a device reboot. This is designed to evade forensic analysis, as the crash dump would contain evidence of compromise and provide additional forensic details to investigators.\n  * Hook the AAA (Authentication, Authorization and Accounting) function to allow for a magic number authentication capability. When the attacker attempts to connect to the device using this magic number, they are able to establish a remote access VPN tunnel bypassing the configured AAA mechanisms. As an alternate form of access, a P12 blob is generated along with an associated certificate and exfiltrated to the actor along with a certificate-based tunnel configuration.\n\n## Host-Scan-Reply hook overview\n\nIn the Line Dancer implant\u2019s process memory, we found a function (detailed\nbelow) that checks if a 32-byte token matches a pattern. If so, it\nbase64-decodes the payload, copies it into the attacker's writable and\nexecutable memory region, and then calls the newly decoded function. Either\nway, it ends by calling processHostScanReply().\n\nThe function processHostScanReply() is normally accessed through a function\npointer in the elementArray table, associated with the string host-scan-reply.\nIn the captured memory, the entry that should point to processHostScanReply()\nnow instead points to the attacker's function that decodes and runs its\npayload. Since this change is in the data section of memory, it doesn't show\nup in hashes/dumps of text.\n\nThe attacker function that decodes and runs its payload has the following\ndecompilation:\n\n## Line Runner: Persistence Mechanism\n\nThe threat actor maintains persistence utilizing a second, but persistent,\nbackdoor called \u201cLine Runner\u201d on the compromised ASA device using\nfunctionality related to a legacy capability that allowed for the pre-loading\nof VPN clients and plugins on the device. At boot, the ASA is designed to look\nfor the presence of a file on disk0: matching the Lua regular expression:\n\n    \n    \n    ^client_bundle[%w_-]*%.zip$\n\nIf the file exists, it will unzip it and execute the script csco_config.lua.\nOnce processed, the ZIP file is deleted. This is assigned CVE-2024-20359 and\nmore details are available in this Cisco Security Advisory.\n\nIn at least one case, there is another vulnerability, CVE-2024-20353, that was\nabused by the actor to facilitate this process. The attackers were able to\nleverage this vulnerability to cause the target ASA device to reboot,\ntriggering the unzipping and installing the second component of the threat\nactor\u2019s malware implant, Line Runner.\n\nThe threat actor\u2019s ZIP file has the following files:\n\nThe scripts in the zip file allow the threat actor to maintain a persistent\nHTTP-based Lua backdoor to the ASA, which survives across reboots and\nupgrades. Line Runner was observed being used by UAT4356 to retrieve\ninformation that was staged through the use of Line Dancer.\n\n### csco_config.lua\n\nThe csco_config.lua file is run at boot and makes the following modifications\nto the system:\n\n\u2022 Create disk0:/csco_config/97/webcontent/ if it doesn't already exist \u2022\nCreate disk0:/csco_config/97/webcontent/1515480F4B538B669648B17C02337098 from\nhash.txt \u2022 Append index.txt to disk0:/csco_config/97/webcontent/index_bp.ini\nand put the result in disk0:/csco_config/97/webcontent/index.ini \u2022 Move the\noriginal client_bundle.zip file to /run/lock/subsys/krbkdc6 \u2022 Prepend\numtfc.txt to /etc/init.d/umountfs \u2022 Copy stgvdr.txt to /asa/scripts/lina_cs \u2022\nBackup /asa/scripts/lina_exe_cs.sh to /asa/scripts/lina_exe_cs_bp.sh \u2022 Replace\n/asa/scripts/lina_exe_cs.sh with laecsnw.txt \u2022 Copy csco_config2.lua over\ncsco_config.lua \u2022 Disable the importPlugin function for the next call only\n\n### csco_config2.lua\n\nThe csco_config2.lua file cleans up the modifications made by csco_config.lua\n(above) and removes itself.\n\n### hash.txt\n\nUsed as content for\ndisk0:/csco_config/97/webcontent/1515480F4B538B669648B17C02337098.\n\nIntercepts HTTP requests to the ASA. The threat actor\u2019s code looks for an HTTP\nrequest with a set of 32-character parameters that are victim-dependent. If\nthey match, then the payload contained within one of these parameters is\nwritten to a Lua script and executed. This is the backdoor\u2019s command and\ncontrol mechanism.\n\n### index.txt\n\nAdds webContent information so hash.txt is processed.\n\n### laecsnw.txt\n\nTemporarily replaces /asa/scripts/lina_exe_cs.sh.\n\nExecutes /asa/scripts/lina_cs as a background process (see below). Removes\nitself. Then restore the backup /asa/scripts/lina_exe_cs_bp.sh.\n\n### stgvdr.txt\n\nRuns as /asa/scripts/lina_cs.\n\nAfter sleeping for 30 seconds, sets expected owner and times on\n/etc/init.d/umountfs. Removes the hash API endpoint, the index.ini, and either\nrestores the backup index.ini or removes the webcontent directory entirely.\nFinally, removes itself.\n\n### umtfc.txt\n\nPrepended to /etc/init.d/unmountfs.\n\nThe unmountfs script is called at shutdown to unmount the filesystems. The\nthreat actor\u2019s modifications perform the following functionality:\n\n\u2022 If disk0:/csco_config/97/webcontent/1515480F4B538B669648B17C02337098 exists,\nit removes it and index.ini. \u2022 Copy /run/lock/subsys/krbkdc6 to\ndisk0:client_bundle_install.zip\n\nThis sets up the zipfile to be executed at the next boot, maintaining\npersistence.\n\n## Forensic Recovery and Identification of Line Runner\n\nTo identify the presence of Line Runner on an ASA, the following methods can\nbe used. Note also that the device should be upgraded to a fixed version as\nidentified in the first method.\n\n### Method 1:\n\nAfter updating the device to a software release that contains the fix for\nCVE-2024-20359, a review of the contents of disk0: should be conducted. If a\nnew file (e.g., \u201cclient_bundle_install.zip\u201d or any other unusual .zip file)\nappears on disk0: following the update, this suggests that Line Runner was\npresent on the device in question. Note that because the updated software is\nnot vulnerable to CVE-2024-20359, Line Runner will no longer be active on the\ndevice.\n\n### Method 2:\n\nTo detect (and remove) Line Runner, the following series of commands will\ncreate an innocuous file with a .zip extension. Note that it will not create a\nvalid zip file, but the file will still be read by the ASA at reboot. Upon\nexecution of the following commands, if a new .zip file appears on disk0:\nfollowing the reload, this suggests that Line Runner was present on the device\nin question. Deletion of the \u201cclient_bundle_install.zip\u201d file will remove Line\nRunner. Note that the malicious ZIP containing the Line Runner functionality\ncould have other names that fit the naming pattern outlined previously.\n\nIf you discover a newly created .zip file, copy that file off the device using\nthe copy command and contact psirt@cisco.com referencing CVE-2024-20359.\nInclude the outputs of the dir disk0: and show version commands from the\ndevice and the .zip file extracted from the device.\n\n## Anti-Forensics/Anti-Analysis Capabilities\n\nUAT4356 took clear and deliberate steps to attempt to prevent forensic capture\nof malicious artifacts. This tradecraft suggests a thorough understanding of\nthe ASA itself and of the forensic actions commonly performed by Cisco for\nnetwork device integrity validation. Additional steps were taken on a case-by-\ncase basis to hide actions being taken on the device. These steps included\nhooking the AAA (Authentication, Authorization and Accounting) function of the\ndevice to allow the actor to bypass normal AAA operations. We also identified\nsome instances where UAT4356 disabled logging to perform operations on or from\nthe ASA and not have those operations or actions logged.\n\nLine Dancer appears to have been intentionally placed into a difficult-to-\nreach region of memory. In addition, it hooks into functions such as the core\ndump function, which is commonly used to collect information for debugging and\nforensic purposes, which were made in memory such that this function simply\njumped to a reboot. This means that on reboot, Line Dancer itself would no\nlonger be present and none of the collections present in the core dump\nfunction would have been executed, all resulting in a complete loss of debug\ninformation and memory-based forensic artifacts.\n\n## Attribution\n\nAs a part of our ongoing investigation, we have also conducted analysis on\npossible attribution of this activity. Our attribution assessment is based on\nthe victimology, the significant level of tradecraft employed in terms of\ncapability development and anti-forensic measures, and the identification and\nsubsequent chaining together of 0-day vulnerabilities. For these reasons, we\nassess with high confidence that these actions were performed by a state-\nsponsored actor.\n\n## Recommendations\n\nThere are some known indicators of compromise that customers can look for if\nthey suspect they may have been targeted in this campaign. First,\norganizations should look for any flows to/from ASA devices to any of the IP\naddresses present in the IOC list provided at the bottom of this blog. This is\none indication that further investigation is necessary.\n\nAdditionally, organizations can issue the command show memory region | include lina to identify another indicator of compromise. If the output indicates more than one executable memory region (memory regions having r-xp permissions, see output examples), especially if one of these memory sections is exactly 0x1000 bytes, then this is a sign of potential tampering.\n\nOutput of the \u2018show memory region\u2019 command for a compromised device (top) vs.\na clean device (bottom).\n\nNote that the earlier provided steps to identify the presence of Line Runner\ncan still be followed even in the absence of more than one executable memory\nregion as we have seen cases where Line Runner was present without Line Dancer\nbeing present. We still recommend following the steps to upgrade to a patched\nversion even if customers believe that their device has not been compromised.\n\nNext, follow the steps detailed in the Cisco ASA Forensic Investigation\nProcedures for First Responders. When following these procedures first\nresponders should NOT attempt to collect a core dump (Step 5) or reboot the\ndevice if they believe that the device has been compromised, based on the lina\nmemory region output. The previous steps up to and including a collection of\nthe memory text section should be followed. In addition, we have released some\nSnort signatures to detect the activity on the wire including access attempts.\nSignatures 63139, 62949, and 45575 have been released to detect the implants\nor associated behaviors. Please note that the device must be set up to decrypt\nTLS for these signatures to be effective.\n\n  * CVE-2024-20353 (ASA DOS/Reboot) - 3:63139\n  * \u2018Line Runner\u2019 \u2013 Persistence Mechanism Interaction \u2013 3:62949\n  * \u2018Line Dancer\u2019 \u2013 In-Memory Only Shellcode Interpreter Interaction \u2013 3:45575\n  * Note that this signature was originally built to detect an unrelated CVE but it also detects Line Dancer interaction\n\nIf your organization does find connections to the provided actor IPs and the\ncrash dump functionality has been altered, please open a case with Cisco TAC.\n\n## UAT4356 Infrastructure\n\nKey components of the actor-controlled infrastructure used for this operation\nhad an interesting overlap of SSL certificates which match the below pattern\nwhile also appearing as an ASA, during the same period, to external scanning\nengines such as Shodan and Censys as reported by the CPE data on the same port\nas the noted SSL certificate. The SSL certificate information suggests that\nthe infrastructure is making use of an OpenConnect VPN Server\n(https://ocserv.openconnect-vpn.net) through which the actor appeared to be\nconducting actions on target.\n\nCertificate Pattern: :issuer = O=ocserv,CN=ocserv VPN :selfsigned = true\n:serial = 0000000000000000000000000000000000000002 :subject =\nO=ocserv,CN=ocserv VPN :version = v3\n\nCPE identifiers: cpe:2.3:a:cisco:http:*:*:*:*:*:*::\ncpe:2.3:h:cisco:adaptive_security_appliance:*:*:*:*:*:*:*:*\ncpe:2.3:o:cisco:adaptive_security_appliance_software:*:*:*:*:*:*:*:*\n\n## MITRE TTPs\n\nThis threat demonstrates several techniques of the MITRE ATT&CK framework,\nmost notably:\n\n  * Line Runner persistence mechanism (T1037),\n  * The reboot action via CVE-2024-20353 (T1653),\n  * Base64 obfuscation (T1140),\n  * Hooking of the processHostScanReply() function (T0874),\n  * Disabling syslog and tampering with AAA (T1562-001),\n  * Injection of code into AAA and Crash Dump processes (T1055)\n  * Execution of CLI commands (T1059),\n  * Bypassing of the AAA mechanism (T1556),\n  * Removal of files after execution (T1070-004),\n  * HTTP interception for C2 communications (T1557),\n  * HTTP C2 (T1071-001),\n  * HTTP C2 one-way backdoor (T1102-003),\n  * Data exfiltration over C2 (T1041),\n  * Network sniffing (T1040)\n\n## Coverage\n\nCisco Secure Firewall (formerly Next-Generation Firewall and Firepower NGFW)\nappliances such as Threat Defense Virtual, Adaptive Security Appliance and\nMeraki MX can detect malicious activity associated with this threat.\n\nUmbrella, Cisco's secure internet gateway (SIG) blocks devices from connecting\nto malicious IPs. Sign up for a free trial of Umbrella here.\n\nAdditional protections with context to your specific environment and threat\ndata are available from the Firewall Management Center.\n\nOpen-source Snort Subscriber Rule Set customers can stay up to date by\ndownloading the latest rule pack available for purchase on Snort.org. Snort\nSIDs for this threat are 45575, 62949 and 63139.\n\n## Indicators of Compromise (IOCs)\n\nThere are several known indicators of compromise that defenders can look for\nwhen assessing whether their ASA device has been compromised as a result of\nthis attack, as outlined earlier in this post. For example, if any gaps in\nlogging or any recent unexpected reboots are observed, this should be treated\nas suspicious activity that warrants further investigation. Also, below is a\nlist of IP addresses we identified as having been used by UAT4356. Please note\nthat some of these IPs are part of publicly known anonymization infrastructure\nand not directly controlled by the attackers themselves. If your organization\ndoes find connections to the provided actor IPs and the crash dump\nfunctionality has been altered, please open a case with Cisco TAC.\n\n### Likely Actor-Controlled Infrastructure:\n\n192.36.57[.]181 185.167.60[.]85 185.227.111[.]17 176.31.18[.]153\n172.105.90[.]154 185.244.210[.]120 45.86.163[.]224 172.105.94[.]93\n213.156.138[.]77 89.44.198[.]189 45.77.52[.]253 103.114.200[.]230\n212.193.2[.]48 51.15.145[.]37 89.44.198[.]196 131.196.252[.]148\n213.156.138[.]78 121.227.168[.]69 213.156.138[.]68 194.4.49[.]6\n185.244.210[.]65 216.238.75[.]155\n\n### Multi-Tenant Infrastructure:\n\n5.183.95[.]95 45.63.119[.]131 45.76.118[.]87 45.77.54[.]14 45.86.163[.]244\n45.128.134[.]189 89.44.198[.]16 96.44.159[.]46 103.20.222[.]218\n103.27.132[.]69 103.51.140[.]101 103.119.3[.]230 103.125.218[.]198\n104.156.232[.]22 107.148.19[.]88 107.172.16[.]208 107.173.140[.]111\n121.37.174[.]139 139.162.135[.]12 149.28.166[.]244 152.70.83[.]47\n154.22.235[.]13 154.22.235[.]17 154.39.142[.]47 172.233.245[.]241\n185.123.101[.]250 192.210.137[.]35 194.32.78[.]183 205.234.232[.]196\n207.148.74[.]250 216.155.157[.]136 216.238.66[.]251 216.238.71[.]49\n216.238.72[.]201 216.238.74[.]95 216.238.81[.]149 216.238.85[.]220\n216.238.86[.]24\n\n## Acknowledgments\n\nCisco would like to thank the following organizations for supporting this\ninvestigation:\n\n  * Australian Signals Directorate\u2019s Australian Cyber Security Centre\n  * Black Lotus Labs at Lumen Technologies\n  * Canadian Centre for Cyber Security, a part of the Communications Security Establishment\n  * Microsoft Threat Intelligence Center\n  * The UK's National Cyber Security Centre (NCSC)\n  * U.S. Cybersecurity & Infrastructure Security Agency (CISA)\n\n##### Share this post\n\n#### Related Content\n\n### Large-scale brute-force activity targeting VPNs, SSH services with\ncommonly used login credentials\n\nApril 16, 2024 08:00\n\nCisco Talos would like to acknowledge Brandon White of Cisco Talos and Phillip\nSchafer, Mike Moran, and Becca Lynch of the Duo Security Research team for\ntheir research that led to the identification of these attacks. Cisco Talos is\nactively monitoring a global increase in brute-force attacks against a variety\n\n### Active exploitation of Cisco IOS XE Software Web Management User Interface\nvulnerabilities\n\nOctober 16, 2023 11:05\n\nCisco has identified active exploitation of two previously unknown\nvulnerabilities in the Web User Interface (Web UI) feature of Cisco IOS XE\nsoftware \u2014 CVE-2023-20198 and CVE-2023-20273 \u2014 when exposed to the internet or\nuntrusted networks.\n\n### What to know about the HTTP/2 Rapid Reset DDoS attacks\n\nOctober 11, 2023 19:06\n\nCVE-2023-44487, a vulnerability in the HTTP/2 protocol, was recently used to\nlaunch intensive DDoS attacks against several targets.\n\n  *     * ###### Intelligence Center\n\n    * Intelligence Search\n    * Email & Spam Trends\n  *     * ###### Vulnerability Research\n\n    * Vulnerability Reports\n    * Microsoft Advisories\n  *     * ###### Incident Response\n\n    * Talos IR Capabilities\n    * Emergency Support\n  *     * ###### Security Resources\n\n    * Open Source Security Tools\n    * Intelligence Categories Reference\n    * Secure Endpoint Naming Reference\n  *     * ###### Media\n\n    * Talos Intelligence Blog\n    * Threat Source Newsletter\n    * Beers with Talos Podcast\n    * Talos Takes Podcast\n    * Talos Videos\n  *     * ###### Support\n\n    * Support Documentation\n  *     * ###### Company\n\n    * About Talos\n    * Careers\n    * Cisco Security\n\n###### Follow us\n\n\u00a9 2024 Cisco Systems, Inc. and/or its affiliates. All rights reserved. View\nour Privacy Policy.\n\n", "frontpage": false}
