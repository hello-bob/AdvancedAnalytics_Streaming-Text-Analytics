{"aid": "40199043", "title": "Fedora 21 Proposal: Replace Redis with Valkey system-wide", "url": "https://discussion.fedoraproject.org/t/f41-change-proposal-replace-redis-with-valkey-system-wide/113413", "domain": "fedoraproject.org", "votes": 1, "user": "nateb2022", "posted_at": "2024-04-29 14:49:18", "comments": 0, "source_title": "F41 Change Proposal: Replace Redis with Valkey (system-wide) - Fedora Discussion", "source_text": "F41 Change Proposal: Replace Redis with Valkey (system-wide) - Fedora\nDiscussion\n\n\ud83c\udf6a This website uses cookies to function. The compliance people asked us to\ntell you. More information.\n\nFine.\n\nSkip to main content\n\nWelcome to Fedora Discussion!\n\nCheck out the our guide to navigation: tags, categories, and concepts, or add\nto our tips and tricks.\n\n#\n\nF41 Change Proposal: Replace Redis with Valkey (system-wide)\n\nProject DiscussionChange Proposals\n\nfescof41\n\nYou have selected 0 posts.\n\nselect all\n\ncancel selecting\n\nJonathan WrightjonathanspwPackaging Team\n\n12d\n\n# Replace Redis with Valkey\n\nThis is a proposed Change for Fedora Linux. This document represents a\nproposed Change. As part of the Changes process, proposals are publicly\nannounced in order to receive community feedback. This proposal will only be\nimplemented if approved by the Fedora Engineering Steering Committee.\n\nWiki 1 Announced\n\n## Summary\n\nObsolete Redis for Valkey due to Redis\u2019s license change to RASLv2/SSPL.\n\n## Owner\n\n  * Name: Jonathan Wright\n  * Email: jonathan@almalinux.org\n\n## Detailed Description\n\nWe will replace Redis with Valkey due to the recent licensing changes in\nRedis, which have rendered it incompatible with Free and Open Source Software\n(FOSS) principles. This shift in Redis\u2019s licensing can impact Fedora\u2019s\ncommitment to FOSS, potentially limiting users\u2019 freedom to modify and\nredistribute the software under the same terms. Valkey, a fork of Redis,\nemerges as a viable alternative because it retains a FOSS-compatible license\nand has robust community and developmental support. Adopting Valkey allows us\nto continue offering users a powerful in-memory data structure store without\ncompromising on licensing restrictions.\n\n## Feedback\n\n## Benefit to Fedora\n\nRedis previously used the BSD license. Redis\u2019s shift to the Server Side Public\nLicense (SSPL) that Fedora does not allow poses an issue. Valkey adheres to\nthe original BSD licensing model, thus maintaining full FOSS compatibility.\nThis commitment is bolstered by substantial backing from the Linux Foundation\nand the migration of many former Redis contributors to Valkey, ensuring a\nrobust development environment and continuity of expertise.\n\nAs the package owner of Valkey in Fedora, my interactions with the Valkey\nupstream project have underscored their strong dedication to working with\ndistributions. The Valkey team is responsive and proactive in discussions,\nwhich facilitates effective package management and integration within Fedora.\nTheir commitment to open collaboration significantly benefits Fedora, ensuring\nthat Valkey is not only technically sound, but also aligns with Fedora\u2019s\nprinciples and community values.\n\nThis shift to Valkey allows Fedora to maintain its leadership in offering\npowerful FOSS-aligned technologies while supporting a project that values open\nsource integrity and collaboration. This is crucial for keeping Fedora at the\nforefront of providing robust, community-supported software solutions to its\nusers.\n\n## Scope\n\n  * Proposal owners: add a valkey-compat package which will port Redis configurations to Valkey. Valkey 7.2.5 is 100% compatible with Redis. Add \u201cObsolete: redis\u201d to valkey-compat package. valkey-compat will require valkey. This will allow us to eventually retire the valkey-compat sub-package at some point in the future.\n\n  * Other developers: N/A\n\n  * Release engineering: N/A\n\n  * Policies and guidelines: N/A (not needed for this Change)\n\n  * Trademark approval: N/A (not needed for this Change)\n\n  * Alignment with Community Initiatives: N/A\n\n## Upgrade/compatibility impact\n\nWhen upgrading to Fedora Linux 41, systems with redis installed will be\nswitched to valkey via the valkey-compat package. The change should be mostly\ntransparent to users as the valkey-compat package provides config and data\nmigration for most common configurations. The valkey systemd units will have\naliases for redis to ease the migration for users.\n\n## How To Test\n\nA COPR is available at jonathanspw/valkey Copr 1 with the \u201cObsoletes\u201d in place\nso the migration script can be tested.\n\n## User Experience\n\nThis is intended to be as invisible to users as possible. If the change\nproposal is approved the valkey serviced units will be aliased to\nredis.service to ease the transition.\n\n## Dependencies\n\n## Contingency Plan\n\n  * Contingency mechanism: (What to do? Who will do it?) Do not obsolete Redis with Valkey\n  * Contingency deadline: N/A\n  * Blocks release? No\n\n## Documentation\n\nN/A (not a System Wide Change)\n\n## Release Notes\n\n> Last edited by @amoloney April 17, 2024 3:41 PM\n\n  * #### created\n\n12d\n\n  * #### last reply\n\n8h\n\n  * 16\n\n#### replies\n\n  * 566\n\n#### views\n\n  * 8\n\n#### users\n\n  * 12\n\n#### likes\n\n  * 5\n\n4\n\n2\n\nsystem\n\nJonathan Wright\n\n12d\n\n## How do you feel about the proposal as written?\n\n  * Strongly in favor\n  * In favor, with reservations\n  * Neutral\n  * Opposed, but could be convinced\n  * Strongly opposed\n\n23voters\n\nIf you are in favor but have reservations, or are opposed but something could\nchange your mind, please explain in a reply.\n\nWe want everyone to be heard, but many posts repeating the same thing actually\nmakes that harder. If you have something new to say, please say it. If,\ninstead, you find someone has already covered what you\u2019d like to express,\nplease simply giving that post a instead of reiterating. You can even do this\nby email, by replying with the heart emoji or just \u201c+1\u201d. This will make long\ntopics easier to follow.\n\nPlease note that this is an advisory \u201cstraw poll\u201d meant to gauge sentiment. It\nisn\u2019t a vote or a scientific survey. See About the Change Proposals category\nfor more about the Change Process and moderation policy.\n\nMatthew MillermattdmCouncil Member\n\n12d\n\nJonathan Wright:\n\n> When upgrading to Fedora Linux 41, systems with redis installed will be\n> switched to valkey via the valkey-compat package. The change should be\n> mostly transparent to users as the valkey-compat package provides config and\n> data migration for most common configurations. The valkey systemd units will\n> have aliases for redis to ease the migration for users.\n\nIs this to be done with RPM package scripts, or is it a systemd one-shot, or\nsomething else?\n\nI\u2019m torn between \u201cjust works\u201d and \u201cuser control / least surprise\u201d here.\n\nRPM scripts can be really confusing, fragile \u2014 and hard to fix if something\nsurprising goes wrong that breaks further upgrades.\n\nJonathan WrightjonathanspwPackaging Team\n\nMatthew Miller\n\n12d\n\nThe intent is to execute an included bash script. In POC testing it works\nwell.\n\nWhat is actually required to move from Redis to Valkey is rather simple - copy\nthe config to /etc/valkey/valkey.conf, stop redis (handled by Obsoletes in the\ncompat package containing the scripts), copy the rdb data files into the\nvalkey data dir, then start valkey.\n\nPOC script: Tree - rpms/valkey - src.fedoraproject.org 1\n\nI\u2019m open to suggestions or better ideas if any exist, however.\n\nNeal GompangompaProven Packager\n\n12d\n\nJonathan Wright:\n\n> ## Upgrade/compatibility impact\n>\n> When upgrading to Fedora Linux 41, systems with redis installed will be\n> switched to valkey via the valkey-compat package. The change should be\n> mostly transparent to users as the valkey-compat package provides config and\n> data migration for most common configurations. The valkey systemd units will\n> have aliases for redis to ease the migration for users.\n\nI think this should be fine, but I\u2019d call this package valkey-redis-compat or\nvalkey-compat-redis (depending on how you prefer naming conventions). This is\nspecifically about replacing Redis, not other things.\n\nJonathan WrightjonathanspwPackaging Team\n\nNeal Gompa\n\n12d\n\nI\u2019m not too picky on the naming and I like this idea too. I\u2019d lean towards the\nlatter name, valkey-compat-redis as I feel it\u2019s more clear but truth be told\nif someone had a strong argument for the former I could be swayed.\n\nMatthew MillermattdmCouncil Member\n\nJonathan Wright\n\n12d\n\nI will defer to FESCo and the FPC on any guidelines on the best way to handle\nthis kind of thing. I\u2019m generally in favor of this, just wanted to make sure\nthe issue was raised.\n\nRemi ColletremiPackaging Team\n\n11d\n\nI agree we\u2019ll have to get rid of redis in the future, and than such a switch\nwill make a strong statement about our disapproval to redis about this License\nchange.\n\nBut I also think this is a bit early (F41)\n\n  * Valkey is very young, and they is no proof it will be best choice\n\n  * Redis 7.2 is still there and maintained (even version 6.2 and 7.0 are maintained), and keeping it have no security issue.\n\nSo I\u2019m -1 for F41 and probably +1 for F42\n\nNathan ScottnathansPackaging Team\n\n11d\n\nI also would likely support a similar proposal for f42, with the caveats\nlisted below.\n\n  * This change proposal potentially breaks multiple existing packages and time will be needed to manage the transition so that Fedora users are not affected. The three redis module packages we ship are directly broken and their migration needs more planning. However, they\u2019re not the only packages impacted. Just in my immediate sphere, all of pcp, grafana, cockpit-pcp, ansible-pcp, grafana-pcp and the linux-system-roles packages are impacted.\n\n  * Making these packages valkey-aware is a prerequisite before this full-redis-replacement proposal proceeds.\n\n  * Move the redis command compatibility symlinks to valkey-compat (or whatever it becomes).\n\n  * Move the Conflicts: line from valkey to valkey-compat (or whatever it becomes) and remove the valkey-devel Conflicts: line, there are no conflicting files there.\n\n  * The redis man page patch that was removed should have s/redis/valkey/g applied and be reinstated in valkey.spec - I\u2019ll open a separate bug for this as Neal mentioned there should be further changes and an upstream PR opened for this.\n\n  * The redis/valkey-doc sub-package that was removed needs to be reinstated, this is used to ensure up-to-date docs are used in the build (see src/commands.def) - I\u2019ll open a separate bug for this.\n\n  * The valkey package should be group maintained with the existing redis package maintainers (if they wish). This is feeling a bit like a hostile takeover currently and that\u2019s really unnecessary.\n\nAs shown above, redis/valkey packaging has subtleties and numerous dependent\npackages need detailed consideration. We are fortunate to have maintainers who\nhave been working on this package for many years - let\u2019s draw on their\nexperience with valkey going forward please.\n\nNathan ScottnathansPackaging Team\n\nNathan Scott\n\n11d\n\nThe documentation bugs I mentioned above are now:\nhttps://bugzilla.redhat.com/show_bug.cgi?id=2276017 1\nhttps://bugzilla.redhat.com/show_bug.cgi?id=2276020 1\n\nI\u2019d like to see these resolved too as part of this proposal as they\u2019re\nregressions from the redis package being replaced.\n\nNathan ScottnathansPackaging Team\n\nJonathan Wright\n\n11d\n\nI think there may be a problem with the way this script handles permissions. I\nsee it does a mv not cp (good thing, these files can be huge) but the\npermissions are like:\n\n# find /var/lib/redis/ | xargs ls -ld\n\ndrwxr-x\u2014. 1 redis redis 48 Apr 19 13:20 /var/lib/redis/ -rw-r\u2013r\u2013. 1 redis\nredis 341451234 Apr 19 13:19 /var/lib/redis/dump.rdb -rw-r\u2013r\u2013. 1 redis redis\n124170240 Apr 19 13:20 /var/lib/redis/temp-2823803.rdb\n\nThe script will end up with files owned and writable only by the redis user\nwhen moved into the valkey location. This can be fixed by judicious use of\nchown (as long as the valkey account exists when this script is run), but care\nalso needs to be taken to ensure redis-server is not running, actively writing\nto the rdb file (script could check that using a redis-cli PING).\n\nJonathan WrightjonathanspwPackaging Team\n\nNathan Scott\n\n11d\n\nIt\u2019s a very early draft/POC. It needs quite a bit of work and plenty of extra\nchecks before being production ready. Since F41 is 6 months away we have\nplenty of time to perfect it.\n\nI didn\u2019t want to spend too much time on the scripts yet in case the proposal\ngot vehemently rejected for whatever reason.\n\nNathan ScottnathansPackaging Team\n\n10d\n\nFWIW, I can\u2019t imagine anyone outright rejecting this approach (perhaps redict\nfolk?) - its on the right track, IMO, and we all know some action must be\ntaken to drop redis in the not-too-distant future.\n\nLet\u2019s just slow it down and take extra care. Data loss can easily be the\nresult of any mistakes we accidentally make here.\n\nNathan ScottnathansPackaging Team\n\nJonathan Wright\n\n10d\n\nJonathan Wright:\n\n> I didn\u2019t want to spend too much time on the scripts yet\n\nThat\u2019s no problem, it\u2019ll improve with time for sure.\n\nGiven this though, and the accidental redis data loss scenario a valkey\ninstall can cause (described on fedora-devel), I think we should hold off on\nthe valkey update that is currently in testing for stable Fedora and EPEL\n(rawhide totally appropriate though).\n\nNeal GompangompaProven Packager\n\n10d\n\nNathan Scott:\n\n> Given this though, and the accidental redis data loss scenario a valkey\n> install can cause (described on fedora-devel), I think we should hold off on\n> the valkey update that is currently in testing for stable Fedora and EPEL\n> (rawhide totally appropriate though).\n\nThe easier thing to do is to simply disable the compat subpackage until we\nhave it worked out for F41. That\u2019s straightforward enough to do and does not\ninhibit the progress of getting Valkey to replace Redis in F41.\n\n9 days later\n\nAoife MoloneyamoloneyLet Me Introduce Myself\n\n19h\n\nThis change proposal has now been submitted to FESCo with ticket #3203 5 for\nvoting.\n\nTo find out more, please visit our Changes Policy documentation.\n\nmartin lutherfrankjunior\n\n8h\n\nGitHub\n\n### GitHub - Snapchat/KeyDB: A Multithreaded Fork of Redis 1\n\nA Multithreaded Fork of Redis. Contribute to Snapchat/KeyDB development by\ncreating an account on GitHub.\n\n### Related Topics\n\nTopic| Replies| Views| Activity  \n---|---|---|---  \nRedis replacement - Help with KeyDBProject Discussionpackage-maintainers| 237|\nMar 21  \nF41 Change Proposal: Disable openSSL Engine Support (system-wide)Change\nProposalsfescof41| 171| Mar 19  \nF41 Change Proposal: OpenSSL Deprecate Engine (system-wide)Change\nProposalsfescof41| 184| 16d  \nF40 Change Proposal: Removing OpenSSL 1.1 package (System-Wide)Change\nProposalsf40fesco| 503| Dec 2023  \nF41 Change Proposal: Switch to DNF 5 (System-Wide)Change Proposalsfescof41|\n966| 4d  \n  \nIt\u2019s your OS.\n\n  * Get Fedora Linux\n  * Fedora Documentation\n  * About the Fedora Project\n  * Code of Conduct\n  * Privacy Statement\n\n", "frontpage": false}
