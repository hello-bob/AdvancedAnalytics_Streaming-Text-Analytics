{"aid": "40049961", "title": "Using OPNsense and IP blocklists to block malicious traffic (2022)", "url": "https://www.allthingstech.ch/using-opnsense-and-ip-blocklists-to-block-malicious-traffic", "domain": "allthingstech.ch", "votes": 1, "user": "transpute", "posted_at": "2024-04-16 09:24:02", "comments": 0, "source_title": "Using OPNsense and IP blocklists to block malicious traffic", "source_text": "Using OPNsense and IP blocklists to block malicious traffic\n\n# Using OPNsense and IP blocklists to block malicious traffic\n\n## Blocking traffic from malicious IPs with OPNsense using public IP\nblocklists is simple and effective. Read how it's done:\n\nReto Haeberli\n\n\u00b7May 22, 2022\u00b7\n\n5 min read\n\nPhoto by Kai Pilger on Unsplash\n\n## Table of contents\n\n  * Why Blocking on Layer 3/4 is effective and efficient\n\n  * External blocklists with OPNsense\n\n    * Step 1 - Creating an alias for an external blocklist\n\n    * Step 2 - Configuring a firewall rule\n\n    * Step 3 - Verification of the new firewall rule\n\n  * What next\n\n  * Addendum - Blocklist URLs\n\n### Why Blocking on Layer 3/4 is effective and efficient\n\nBlocking malicious IPs is simple and effective. On one hand it prevents\nconnections to known bad actors from the beginning and on the other hand,\nshould a client become compromised, communication will be blocked reliably\nbefore things may escalate further. Of course this only works as good as the\ncontent of the used blocklists is.\n\nWhile blocking on IP level may seem like a \"brute force\" approach it is in\nfact very simple, effective and reliable, it intercepts connections already at\nLayer 3/4 of the OSI model. Since this happens very early and already on a low\nlevel of the networking stack, the costs in terms of performance are almost\nnothing compared to more sophisticated approaches doing comparable on Layer 7.\n\nBlocking IPs with blocklists on Layer 3/4 is:\n\n  * Effective\n  * Reliable\n  * Simple to set up and maintain\n  * Comes at almost no performance cost\n\nCertainly there are alternative approaches to achieve comparable results.\nHowever nothing beats blocking at Layer 3/4 if one wants to prevent\nconnectivity to a specific IP completely. That said it absolutely makes sense\nto have complementary measures on other Layers such as DNS blocklists and deep\npacket inspection in place, also to catch things that might slip through the\ncoarse grained IP Level blocking only.\n\n## External blocklists with OPNsense\n\nThe use and the management of externally provided IP blocklists with OPNsense\nis very simple and efficient, aliases are the tool of choice for this.\n\n### Step 1 - Creating an alias for an external blocklist\n\nOPNsense supports the use of externals blocklist within aliases and aliases\ncan be used for firewall rules. The start is therefore to create an alias for\nthe desired blocklist and selecting the URL Table (IPs) type.\n\nI chose to use a distinct alias for every blocklist type in order to be able\nto configure the update interval individually and be able to\nactivate/deactivate each one independently. For the update interval make sure\nto respect the recommendations from the list provider to not create\nunnecessary load on their infrastructure.\n\nHint: Use a capital letter alias prefix in order for your custom aliases to\nappear before the system created ones to find them on top of the list.\n\nFor this example spamhaus drop and edrop was used with an update frequency of\n12 hours.\n\n    \n    \n    https://www.spamhaus.org/drop/drop.txt https://www.spamhaus.org/drop/edrop.txt https://www.spamhaus.org/drop/dropv6.txt\n\nAlways inspect the content of the lists prior to first use in order to avoid\nany unpleasant surprises. Some lists contain private IPs that may result in\nblocking local traffic and may even ultimately lock you out of your firewall\nif you're not careful.\n\n### Step 2 - Configuring a firewall rule\n\nThis is one of the situations where it can make sense to configure a floating\nrule since you want to block traffic to and from any of these IPs independent\nof the interface or direction it is originating from at the earliest possible\noccasion. That said just a WAN rule would also be sufficient to block traffic\nfrom and to the WAN interface(s).\n\nNote: Using the floating type rule requires you to be extra careful with the\ncontent of the blocklists as you might lock yourself out if the list contains\nprivate IP address ranges. OPNsense should theoritically prevent you from\nlocking yourself out with standard settings but you may not want to test it.\n\n    \n    \n    Rule category: Floating Action: Block Direction: Any TCP Version: IPv4+IPv6 Protocol: any Logging: Active\n\nMake sure you that you choose the correct settings for Direction, TCP Version,\nProtocol to make the rule applying to all traffic, directions, TCP Versions\nand Protocols.\n\nActivating logging is also recommended in addition to a meaningful description\nof your rule to be able to easily consult the log and understand what is\nhappening at any time. Especially after a few you months you may no remember\neverything so well anymore without a clear description.\n\nNow save the rule and click the Apply changes button in order for the rule to\nbecome active.\n\n### Step 3 - Verification of the new firewall rule\n\nFor the next minutes/hours you want to keep an eye on the log to be sure\neverything works as desired. We nevertheless want to quickly verify that the\nnew rule works as desired. We therefore pick an IP from one of the blocklists\nand try to connect.\n\nping -c 3 24.236.0.1\n\n> PING 24.236.0.1 (24.236.0.1) 56(84) bytes of data. --- 24.236.0.1 ping\n> statistics --- 3 packets transmitted, 0 received, 100% packet loss, time\n> 2050ms\n\nAs expected pinging or trying to connect to a in the blocklist contained IP\ndoes not work and it is also observable in the firewall live log that the\ntraffic is being blocked.\n\n## What next\n\nNow with the foundational mechanism explained and the basic setup working this\ncan easily be extended to additional blocklists for blockling malicious\ntraffic reliably on Layer 3/4.\n\nNote: If you use this feature extensively it may be necessary to increase the\nFirewall Maximum Table Entries or other values in \"Settings -> Advanced\" in\nthe firewall section.\n\nComplementary to this basic level of protection it is of course always\nrecommended to use additional layers of protection such as DNS filtering or\nLayer 7 firewall capabilities. OPNsense offers both as well.\n\nStay safe and secure.\n\n## Addendum - Blocklist URLs\n\nThe URLs of the blocklists used above are:\n\n    \n    \n    # BL_3coresec https://blacklist.3coresec.net/lists/all.txt # BL_abusech_feodo_botnet_c2 https://sslbl.abuse.ch/blacklist/sslipblacklist.txt https://feodotracker.abuse.ch/downloads/ipblocklist_recommended.txt # BL_cins_army https://cinsscore.com/list/ci-badguys.txt # BL_cisco_talos https://talosintelligence.com/documents/ip-blacklist # BL_dshield_30d https://iplists.firehol.org/files/dshield_30d.netset # BL_spamhaus_drop https://www.spamhaus.org/drop/drop.txt https://www.spamhaus.org/drop/edrop.txt https://www.spamhaus.org/drop/dropv6.txt\n\n## Subscribe to our newsletter\n\nRead articles from All Things Tech directly inside your inbox. Subscribe to\nthe newsletter, and don't miss out.\n\n### Did you find this article valuable?\n\nSupport All Things Tech by becoming a sponsor. Any amount is appreciated!\n\nLearn more about Hashnode Sponsors\n\nSecuritynetwork\n\n### Written by\n\n# Reto Haeberli\n\nIT professional from Z\u00fcrich, Switzerland.\n\nIT professional from Z\u00fcrich, Switzerland.\n\n### Published on\n\n# All Things Tech\n\nAll Things Tech - a tech blog.\n\nAll Things Tech - a tech blog.\n\nShare this\n\nArticle Series\n\n### OPNsense\n\n1\n\n# Using OPNsense and IP blocklists to block malicious traffic\n\nWhy Blocking on Layer 3/4 is effective and efficient Blocking malicious IPs is\nsimple and effective....\n\n2\n\n# Blocking DoH with OPNsense using FQDN domain lists\n\nIntroduction This article is a slightly re-written version of the June 2022\nversion. It explains how...\n\n\u00a92024 All Things Tech\n\nArchive\u00b7Privacy policy\u00b7Terms\n\nWrite on Hashnode\n\nPowered by Hashnode - Home for tech writers and readers\n\n", "frontpage": false}
