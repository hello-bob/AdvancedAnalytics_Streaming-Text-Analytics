{"aid": "40184278", "title": "IPsec VPN on OPNsense with iOS, macOS clients (2023)", "url": "https://github.com/thomergil/opnsense-ipsec-vpn", "domain": "github.com/thomergil", "votes": 1, "user": "transpute", "posted_at": "2024-04-27 22:44:50", "comments": 0, "source_title": "GitHub - thomergil/opnsense-ipsec-vpn: Configuring IPsec VPN on OPNsense", "source_text": "GitHub - thomergil/opnsense-ipsec-vpn: Configuring IPsec VPN on OPNsense\n\nSkip to content\n\n## Navigation Menu\n\nSign in\n\n# Search code, repositories, users, issues, pull requests...\n\nSearch syntax tips\n\nSign in\n\nSign up\n\nYou signed in with another tab or window. Reload to refresh your session. You\nsigned out in another tab or window. Reload to refresh your session. You\nswitched accounts on another tab or window. Reload to refresh your session.\nDismiss alert\n\nthomergil / opnsense-ipsec-vpn Public\n\n  * Notifications\n  * Fork 6\n  * Star 21\n\nConfiguring IPsec VPN on OPNsense\n\n21 stars 6 forks Branches Tags Activity\n\nStar\n\nNotifications\n\n# thomergil/opnsense-ipsec-vpn\n\nThis commit does not belong to any branch on this repository, and may belong\nto a fork outside of the repository.\n\n1 Branch\n\n0 Tags\n\n## Folders and files\n\nName| Name| Last commit message| Last commit date  \n---|---|---|---  \n  \n## Latest commit\n\nthomergilMerge pull request #4 from lfuelling/mainNov 25, 20235c00213 \u00b7 Nov\n25, 2023Nov 25, 2023\n\n## History\n\n18 Commits  \n  \n### README.md\n\n|\n\n### README.md\n\n| update instructions for connection uniqueness| Nov 25, 2023  \n  \n## Repository files navigation\n\n# IPsec VPN on OPNsense with iOS, macOS\n\nGetting IPsec VPN on OPNsense to work with iOS and macOS was too difficult.\n\n## Versions\n\nOPNsense 23.1.7_3 iOS 16.4.1 (a) macOS Monterey (Version 12.3)\n\n## Add group \"VPN\" [optional]\n\nThis step is optional, but it helps to ensure that only users in the VPN group\ncan obtain VPN access.\n\nSystem \u2192 Access \u2192 Groups \u2192 + (Add) Group name: VPN Description: VPN users\n\n## Add one VPN user\n\nSystem \u2192 Access \u2192 Users \u2192 + (Add) Username: vpnuser (or any other name that\nyou prefer) Password: [password]\n\nOptional (if you created the VPN group before) Group membership: make sure\nthat \"Member Of\" contains \"VPN\"\n\n## Create IPsec VPN, configure Mobile Clients\n\nVPN \u2192 IPsec \u2192 Mobile Clients [unless otherwise noted, all checkboxes are off]\n\u2705 Enable IPsec Mobile Client Support Backend for authentication: Local\nDatabase (Optional, if you created a \"VPN\" group above): Enforce local group:\nVPN Virtual IPv4 Address Pool: \u2705 Provide a virtual IPv4 address to clients\nVirtual IPv4 Address Pool: 192.168.2.1/24 DNS Servers: \u2705 Provide a DNS server\nlist to clients DNS Servers: Server #1: 192.168.1.1 (this needs to be the\nlocal IP of your OPNsense router) DNS Servers: Server #2: 8.8.8.8 (optional)\nDNS Servers: Server #3: 8.8.4.4 (optional) Phase 2 PFS Group: off [all other\ncheckboxes are off]\n\nSave, Apply changes\n\n## Create IPsec VPN, Create Phase 1\n\nVPN \u2192 IPsec \u2192 Mobile Clients, press on \"Create Phase1\" at the top of the page,\nin the blue message bar. Connection method: default Key Exchange version: auto\nInternet Protocol: IPv4 Interface: WAN Description: Mobile VPN (or anything\nelse descriptive)\n\nPhase 1 proposal (Authentication) Authentication method: Mutual PSK + Xauth My\nidentifier: My IP address Pre-Shared Key: (insert some randomly generate\ngarbage, make sure you store it in a password manager)\n\nPhase 1 proposal (Algorithms) Encryption algorithm: AES Encryption algorithm:\n256 Hash algorithm: SHA256, SHA384, SHA512 DH key group: 2, 5, 14, 15, 16, 17,\n18\n\nAdvanced options [all uncheck unless otherwise noted] Install policy: \u2705 NAT\nTraversal: Enable Lifetime: 28800\n\nSave, Apply changes\n\n## Create IPsec VPN, Create Phase 2\n\nVPN \u2192 IPsec \u2192 Tunnel Settings [legacy], in the newly created Phase 1 row,\npress on the + in the \"Commands\" column. (Do NOT press on the + below the row,\nbecause that creates a new Phase 1 row.)\n\nMode: Tunnel IPv4 Description: (something descriptive or leave empty) Type:\nNetwork Address: 0.0.0.0 / 0 (that is, set \"0.0.0.0\" in the Address field and\nchoose 0 from the dropdown) Protocol: ESP Encryption algorithms: AES128,\nAES192, AES256 Hash algorithms: SHA256, SHA384, SHA512 PFS key group: off\nLifetime: 3600 Automatically ping host: [leave empty]\n\nSave, Apply changes\n\n## Enable IPsec!\n\nVPN \u2192 IPsec \u2192 Tunnel Settings\n\n\u2705 Enable IPsec (near the bottom of the page)\n\nApply changes\n\n## Firewall settings: WAN rules\n\nFirewall \u2192 Rules \u2192 WAN\n\nAdd the following three rules:\n\nInterface: WAN TCP/IP Version: IPv4 Protocol: ESP Source: any Destination: WAN\naddress Description: IPsec ESP\n\nInterface: WAN TCP/IP Version: IPv4 Protocol: TCP/UDP Source: any Destination:\nWAN address Destination port range: from: ISAKMP, to: ISAKMP Description:\nIPsec ISAKMP\n\nInterface: WAN TCP/IP Version: IPv4 Protocol: TCP/UDP Source: any Destination:\nWAN address Destination port range: from: IPsec NAT-T, to: IPsec NAT-T\nDescription: IPsec NAT-T\n\nThe result should be:\n\n    \n    \n    IPv4 ESP * * WAN address * * * IPsec ESP IPv4 TCP/UDP * * WAN address 500 (ISAKMP) * * IPsec ISAKMP IPv4 TCP/UDP * * WAN address 4500 (IPsec NAT-T) * * IPsec NAT-T\n\nApply changes\n\n## Firewall settings: IPsec rules\n\nFirewall \u2192 Rules \u2192 IPsec\n\nAdd the following rule:\n\nInterface: IPsec TCP/IP Version: IPv4 Protocol: any Source: any Destination:\nany\n\nThe result should be:\n\n    \n    \n    IPv4 * * * * * * *\n\nApply changes\n\n## Firewall settings: Outbound NAT\n\nFirewall \u2192 NAT \u2192 Outbound\n\nYou should not have to touch anything here. But verify that Mode is set to\n\"Automatic outbound NAT rule generation\".\n\nAnd verify that in the automatic rules you see the VPN network range listed\nunder Source Networks (so 192.168.2.0/24 in this example).\n\n## Make DNS respond to queries from the VPN\n\nServices \u2192 Unbound DNS \u2192 Access Lists\n\nAdd the following (using the + / Add button):\n\nAccess List name: 192.168.2.0/24 (this is an open field, it does not matter)\nAction: Allow Network: 192.168.2.0 / 24 (this needs to be the range you chose\nunder Mobile Clients) Description: VPN DNS access\n\nSave, Apply changes\n\n## Optional: allow single user to create multiple VPN connections\n\nNormally, a single user cannot create more than one simultaneous VPN\nconnection (for example, using multiple devices). That means that a second\ndevice connecting to VPN with the same username would disconnect the first\ndevice's VPN connection.\n\n### New method\n\nYou can change this by modifying/editing your Phase 1 and change the \"Unique\"\nparameter to one of the following values:\n\n  * Replace\n\n    * A new connection will replace any existing one.\n  * Keep\n\n    * A new connection will be blocked while there is an existing one\n  * No\n\n    * Multiple connections can be made\n  * Never\n\n    * The system will not check for multiple connections\n\nThen save and apply the changes.\n\n### Old Method\n\nPreviously, there was no UI option to fix this, so it required ssh access to\nthe OPNsense server (via System \u2192 Settings \u2192 Administration \u2192 Enable Secure\nShell).\n\nThen ssh into the router, create file\n/usr/local/etc/ipsec.opnsense.d/uniqueids-override.conf and set it with the\nfollowing contents:\n\n    \n    \n    config setup uniqueids = no\n\nThen trigger a VPN restart through the UI.\n\n## Ridiculous: A reboot may be necessary\n\nYes, this is ridiculous, but it did solve DNS problems for me and a number of\nother problems.\n\n## Configuring IPsec VPN on iPhone\n\nFirst make sure that your iPhone is outside of your WLAN.\n\nSettings \u2192 VPN \u2192 Add VPN Configuration...\n\nType: IPsec Description: [whatever you wish] Server: [public IP of OPNsense\nrouter] Account: vpnuser (or the user you added above) Password: [password of\nvpnuser] Use Certificate: [leave off] Group Name: [leave empty] Secret: [use\nthe Pre-Shared Key configured above]\n\n## Configuring IPsec VPN on macOS\n\nSystem Preferences \u2192 Network \u2192 + (Add) button near the bottom left\n\nInterface: VPN, VPN Type: Cisco IPSec Service Name: VPN (OPNsense) (or\nwhatever name you like) Server Address: [public IP of OPNsense router] Account\nName: vpnuser (or the user you added above) Password: [password of vpnuser]\n\nUnder Authentication Settings: Shared Secret: [use the Pre-Shared Key\nconfigured above]\n\n## Sources (thank you!)\n\n  * OPNsense setup, albeit incomplete: https://docs.opnsense.org/manual/vpnet.html\n  * Netgate documentation: https://docs.netgate.com/pfsense/en/latest/recipes/ipsec-mobile-ikev1-xauth.html\n  * A few forum discussions that helped\n\n    * VPN Configuration: https://forum.opnsense.org/index.php?topic=10955.0\n    * Debugging DNS: https://www.reddit.com/r/PFSENSE/comments/5y3qr1/pushing_dns_to_ipsec_clients/\n    * No internet access for VPN clients: https://forum.opnsense.org/index.php?topic=11340.0\n    * No internet access for VPN clients: https://forum.opnsense.org/index.php?topic=7477.0\n    * And more: https://forum.opnsense.org/index.php?topic=14141.0\n    * And even more: https://forum.opnsense.org/index.php?topic=14860.0;prev_next=prev#new\n  * Allowing same user to connect multpile times: https://forum.opnsense.org/index.php?topic=19462.0\n\n## Unrelated: OPNsense OpenVPN for Windows\n\nPretty much did exactly what it says on https://docs.opnsense.org/manual/how-\ntos/sslvpn_client.html with the added note that I checked \"Redirect Gateway\"\nto force all client traffic over the VPN. Furthermore, I used VPN \u2192 OpenVPN \u2192\nClient Export to export the user's configuration as .ovpn file, which can be\nimported directly into OpenVPN for Windows.\n\n## Unrelated: Notes to self\n\nThese are unrelated to the above. To fix slow bootup problems timing out on\nahcich0: https://forum.opnsense.org/index.php?topic=15727.0; in short, add #\nnotrim to the first real line in /etc/fstab.\n\n## About\n\nConfiguring IPsec VPN on OPNsense\n\n### Resources\n\nReadme\n\nActivity\n\n### Stars\n\n21 stars\n\n### Watchers\n\n4 watching\n\n### Forks\n\n6 forks\n\nReport repository\n\n## Releases\n\nNo releases published\n\n## Packages 0\n\nNo packages published\n\n## Contributors 4\n\n  * thomergil Thomer Gil\n  * lfuelling Lerk\n  * LoadingStill Ryan Young\n  * sheepchen Marco Pardo\n\n## Footer\n\n\u00a9 2024 GitHub, Inc.\n\nYou can\u2019t perform that action at this time.\n\n", "frontpage": false}
